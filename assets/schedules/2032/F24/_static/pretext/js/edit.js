function tag_type(e){return["p","ip","mp","fp"].includes(e)?"p":["me","men","md","mdn"].includes(e)?"md":e}function process_value_from_source(e,t,i){editorLog(e,"process_value_from_source",t,"in",i);var n="";if(["literal","codenumber","period","titleperiod","space"].includes(e))n=t;else if(t in i)n=i[t];else if("parent"in i){var o=internalSource[i.parent[0]];t in o?n=o[t]:errorLog("Error: piece",t,"fcn",e,"from",o,"not in src or parent_src")}else errorLog("at the top, or else there is an error");if("capitalize"==e)content=n.charAt(0).toUpperCase()+n.slice(1);else if("literal"==e)editorLog("literally",t),content=t;else if("space"==e)content=n+" ";else if("period"==e)content=n+".";else if("comma"==e)content=n+",";else if("titleperiod"==e)i.title&&!/[!?]$/.test(i.title)&&(content=n+".");else if("percentlist"==e)content=n?n.join("% ")+"%":"MISSING%";else if("nthitem"==e){editorLog("calculating nthitem",t,"from ",n,"within",i),content=n[0]}else"codenumber"==e?(editorLog("   CODENUMBER",i),content=internalSource.root_data.number_base,i["xml:id"]==top_level_id||(content+=".N")):content=n;return content}function randomstring(e){return e||(e=10),"tMP"+(Math.random()+1).toString(36).substring(2,e)}function removeItemFromList(e,t){var i=e.indexOf(t);return i>-1&&e.splice(i,1),e}function rescale(e,t,i,n){return 100*e/(t-parseFloat(i)-parseFloat(n))}function spacemath_to_tex(e){return thetext=e,thetext=thetext.replace(/ d([a-zA-Z])(\s|$)/," \\,d$1$2"),thetext=thetext.replace(/ *< */," &lt; "),thetext}function split_paragraphs(e){var t=e.split("<div><br></div>");editorLog("there were",t.length,"paragraphs, but some may be empty");for(var i=0;i<t.length;++i)editorLog("paragraph",i,"begins",t[i].substring(0,20));var n=[];for(i=0;i<t.length;++i){var o=t[i];(o=(o=(o=(o=(o=(o=(o=o.replace(/<\/div><div>/g,"\n")).replace(/<div>/g,"")).replace(/<\/div>/g,"")).replace(/&nbsp;/g," ")).replace(/ +<br>/g,"\n")).replace(/<br>/g,"\n")).trim())?n.push(o):editorLog("empty paragraph"),editorLog("this_paragraph_contents_raw",o)}return n.length||(n=[""]),n}function past_edits(){return recent_editing_actions.length?recent_editing_actions.map(e=>[e.join(" ")]):[["no chnages yet"]]}function make_current_editing_tree_from_id(e){editorLog("     OOOOO make_current_editing_tree_from_id",e),editorLog("     which has internalSource",internalSource[e]),editorLog("     within",internalSource),editorLog("     and the DOM object is",document.getElementById(e));var t=top_level_id;current_editing={level:-1,location:[],tree:[]};for(var i,n,o=e,r=document.getElementById(o),a=0;o!=t&&a<10;){a+=1,editorLog("ct",a),editorLog("looking to match current_element",r,"until we hit",t),n=next_editable_of(i=r.parentElement.closest("[data-editable]"),"children"),o=i.id,editorLog("current_id",o),current_editing.tree.unshift(n),editorLog("looking for",r,"in",n);for(var s=0;s<n.length;++s){if(r==n[s]){current_editing.level+=1,current_editing.location.unshift(s),editorLog("this is item",s);break}editorLog(r==n[s],"aaa",r,"zzz",n[s])}r=i}current_editing.level+=1,current_editing.location.unshift(0),current_editing.tree.unshift([document.getElementById(t)]),editorLog("built current_editing after",a,"levels"),editorLog("current_editing[level]",current_editing.level),editorLog("current_editing[location]",current_editing.location),editorLog("current_editing[tree]",current_editing.tree),editorLog("     OOOOO   done with  make_current_editing_tree_from_id",e,document.getElementById(e))}function standard_title_form(e){return'<span id="actively_editing" class="starting_point_for_editing" data-source_id="'+e+'" data-component="title" contenteditable="true">'+internalSource[e].title+"</span>"}function standard_caption_form(e){var t=internalSource[e];return editorLog("editing caption of object_id",e,"which contains",t),'<span id="actively_editing" class="starting_point_for_editing" data-source_id="'+e+'" data-component="caption" contenteditable="true">'+t.caption+"</span>"}function menu_options_for(e,t,i){var n;if(t||(t=internalSource[e].sourcetag),editorLog("component_tag",t),"base"==i)n=base_menu_for;else{if("move-or-delete"==i){editorLog("C0 menu options for",t);var o=internalSource[e].parent[0],r=internalSource[o].sourcetag;d="p"==t&&"li"==r?[["move-local-p","Move these words within this page"],["move-local-li","Move this list item within this page"],["move-global","Move this another page (not implemented yet)"],["delete","Delete"]]:"p"==tag_type(t)?[["move-local-p","Move this text within this page"],["move-global","Move to another page (not implemented yet)"],["delete","Delete"]]:[["move-local","Move within this page"],["move-global","Move to another page (not implemented yet)"],["delete","Delete"]];for(var a="",s=0;s<d.length;++s)a+='<li tabindex="-1" data-action="'+d[s][0]+'"',0==s&&(a+=' id="choose_current"'),a+=">",a+=d[s][1],a+="</li>";return editorLog("made this_menu",a),a}if("modify"==i){var d;editorLog("CZ menu options for",t);o=internalSource[e].parent[0],r=internalSource[o].sourcetag;"image"==t?d=[["modify","enlarge","make larger"],["modify","shrink","make smaller"],["modify","left","shift left"],["modify","right","shift right"],["modify","arrows","use arrow keys (not implemented yet)"],["modify","done","done modifying"]]:"sbspanel"==t?d=[["modify","enlarge","make this panel wider"],["modify","shrink","make this panel narrower"],["modify","enlargeall","make all panels wider"],["modify","shrinkall","make all panels narrower"],["modify","leftminus","decrease left margin"],["modify","leftplus","increase left margin"],["modify","rightminus","decrease right margin"],["modify","rightplus","increase right margin"],["modify","done","done modifying"]]:environment_instances["project-like"].includes(t)||"task"==t?d=[["modify","enlarge","more space"],["modify","shrink","less space"],["modify","enlargeslightly","slightly more space"],["modify","shrinkslightly","slightly less space"],["modify","done","done adjusting"]]:(alert("don;t know how to make that menu"),d=[]);for(a="",s=0;s<d.length;++s)a+='<li tabindex="-1" data-action="'+d[s][0]+'" data-modifier="'+d[s][1]+'"',0==s&&(a+=' id="choose_current"'),a+=">",a+=d[s][2],a+="</li>";return editorLog("made this_menu",a),a}if("change"==i){editorLog("C1 menu options for",t),objectclass=objectStructure[t].owner,editorLog("which has class",objectclass);var c=environment_instances[objectclass].slice(),l=removeItemFromList(c,t);editorLog("equivalent_objects",c);for(a="",s=0;s<l.length;++s)a+='<li tabindex="-1" data-action="change-env-to" data-env="'+l[s]+'"',0==s&&(a+=' id="choose_current"'),a+=">",a+=l[s],a+="</li>";return editorLog("made this_menu",a),a}n=submenu_options}editorLog("C2 in menu options for",t,"or",e),editorLog("menu_for",n),t in n?component_items=n[t]:(editorLog("default menu for"+t),component_items=[["paragraph","p"],["math/chemistry/code","math-like","c"],["list or table","list-like"],["image/video/sound","image-like","v"]]),a="";for(s=0;s<component_items.length;++s)this_item=component_items[s],"string"==typeof this_item?(this_item_name=this_item,this_item_label=this_item,this_item_shortcut=""):(this_item_name=this_item[0],this_item_label=this_item_name,this_item_shortcut="",3==this_item.length?(this_item_label=this_item[1],this_item_shortcut=this_item[2]):2==this_item.length&&(this_item_label=this_item[1])),a+='<li tabindex="-1" data-env="'+this_item_label+'"',a+=' data-env-parent="'+t+'"',this_item_shortcut?(a+=' data-jump="'+this_item_name.charAt(0)+" "+this_item_shortcut+'"',this_item_name.match(/^[a-z]/i)&&(this_item_name=this_item_name.replace(this_item_shortcut,"<b>"+this_item_shortcut+"</b>"))):a+='data-jump="'+this_item_name.charAt(0)+'"',0==s&&(a+=' id="choose_current"'),a+=">",this_item_name.match(/^[a-z]/i)&&(first_character=this_item_name.charAt(0),this_item_name=this_item_name.replace(first_character,"<b>"+first_character+"</b>")),a+=this_item_name,this_item_label in submenu_options&&(a+='<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div>'),a+="</li>";return a}function top_menu_options_for(e){editorLog("top menu options for aa",e);var t=e.id,i="";if(e.classList.contains("heading")){var n=e.parentElement;editorLog("heading options for bbb",n);var o=n.id,r=internalSource[o].sourcetag;editorLog("this_obj_environment",r),i='<li tabindex="-1" id="choose_current" data-env="p" data-action="edit">Change the title</li>',i+='<li tabindex="-1" data-action="change-env">Change "'+r+'" to <div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>'}else{var a=e.tagName;if(this_obj_id=e.id,this_obj_id||(this_obj_id=e.getAttribute("data-parent_id"),editorLog("now has id",this_obj_id)),this_obj_source=internalSource[this_obj_id],editorLog("this_obj_source",this_obj_source),editorLog("this_obj",e,"classList",e.classList,"T/F",e.classList.contains("image-box")),r=this_obj_source.sourcetag,"P"==a||e.classList.contains("displaymath")){i='<li tabindex="-1" id="choose_current" data-env="p" data-action="edit">Edit '+r+"</li>";var s=next_editable_of(e,"children");editorLog("editable_children",s),s.length&&"P"!=a&&(i+='<li tabindex="-1" data-env="'+a+'" data-location="enter">Enter '+r+"</li>"),s.length>2&&"SECTION"==a&&(i+='<li tabindex="-1" data-env="'+a+'" data-location="end">Go to end of '+r+"</li>")}else e.classList.contains("image-box")?(editorLog("found an image-box"),i='<li tabindex="-1" id="choose_current" data-env="imagebox" data-action="modify">Modify layout<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>'):e.classList.contains("sbspanel")?i='<li tabindex="-1" id="choose_current" data-env="sbspanel" data-action="modify">Modify layout<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>':(i+='<li tabindex="-1" id="choose_current" data-env="'+a+'" data-location="enter">Enter '+r+"</li>","SECTION"==a&&(i+='<li tabindex="-1" data-env="'+a+'" data-location="end">Go to end of '+r+"</li>"));e.classList.contains("sbspanel")&&(i+='<li tabindex="-1" data-env="sbspanel" data-location="afterbegin">Insert in panel<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>'),e.classList.contains("project-like")&&(i+='<li tabindex="-1" data-env="task">Add a task</li>'),t!=top_level_id&&(i+='<li tabindex="-1" data-env="'+a+'" data-location="beforebegin">Insert before<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>',i+='<li tabindex="-1" data-env="'+a+'" data-location="afterend">Insert after<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>',i+='<li tabindex="-1" data-action="move-or-delete">Move or delete<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>'),i+='<li tabindex="-1" data-env="metaadata">Metadata<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>',t!=top_level_id&&(i+='<li tabindex="-1" data-env="undo">Revert<div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>'),previous_editing()&&t==top_level_id&&(i+='<li tabindex="-1" data-action="resume">Resume previous editing</li>'),i+='<li tabindex="-1" data-action="save">Save</li>',i+='<li tabindex="-1" data-action="stop_editing">Stop editing</li>'}return i}function edit_menu_from_current_editing(e){edit_menu_for(current_editing.tree[current_editing.level][current_editing.location[current_editing.level]],e)}function edit_menu_for(e,t){if(editorLog("make edit menu",t,"for",e),document.getElementById("edit_menu_holder")){var i=document.getElementById("edit_menu_holder");editorLog("current_menu",i),editorLog("this_choice",document.getElementById("enter_choice")),(this_choice=document.getElementById("enter_choice"))&&("stay"==this_choice.getAttribute("data-location")?i.previousSibling.classList.remove("may_leave"):(i.parentElement.classList.remove("may_select"),i.parentElement.classList.remove("may_enter"))),i.parentElement.classList.remove("may_select"),i.parentElement.classList.remove("may_enter"),i.remove()}if(!e)return errorLog("error: empty this_obj_or_id",t),"";editorLog("this_obj_or_id",e,"string?","string"==typeof e),editorLog("which has parent",e.parentElement),this_obj="string"==typeof e?document.getElementById(e):e;var n=this_obj.id;"entering"==t?(menu_location="afterbegin",this_obj.classList.remove("may_leave"),next_editable_of(this_obj,"children").length&&"P"!=this_obj.tagName?this_obj.classList.add("may_enter"):this_obj.classList.add("may_select"),inline_tags.includes(this_obj.tagName.toLowerCase())&&this_obj.classList.add("inline")):(menu_location="afterend",this_obj.classList.remove("may_select"),this_obj.classList.remove("may_enter"),this_obj.classList.add("may_leave"),editorLog("added may_leave to",this_obj));var o=document.createElement("div");o.setAttribute("id","edit_menu_holder"),o.setAttribute("class","edit_menu_holder"),o.setAttribute("tabindex","-1"),editorLog("adding menu for",e,"menu_location",menu_location),editorLog("which has tag",this_obj.tagName),editorLog("does",this_obj.classList,"include type",this_obj.classList.contains("type")),this_obj.insertAdjacentElement(menu_location,o),editorLog("added edit_menu_holder",document.getElementById("edit_menu_holder"),t);var r=document.createElement("span");if(r.setAttribute("id","enter_choice"),"entering"==t)if(editorLog("inline_tags",inline_tags,"tag",this_obj.tagName.toLowerCase()),editorLog("next_editable_of(this_obj, children)",next_editable_of(this_obj,"children")),this_obj.classList.contains("type"))(r=document.createElement("ol")).setAttribute("id","edit_menu"),r.setAttribute("class","edit_menu"),this_obj_parent_id=this_obj.parentElement.parentElement.id,this_obj_environment=internalSource[this_obj_parent_id].sourcetag,r.innerHTML='<li id="choose_current" tabindex="-1" data-action="change-env">Change "'+this_obj_environment+'" to <div class="wrap_to_submenu"><span class="to_submenu">&#9659;</span></div></li>',r.setAttribute("data-location","inline");else if(this_obj.classList.contains("image-box"))r.innerHTML="<b>modify</b> this image layout, or add near here?";else if(this_obj.classList.contains("sbspanel"))r.innerHTML="<b>modify</b> this panel layout, or change panel contents?";else if(this_obj.classList.contains("title")||this_obj.classList.contains("caption")){var a="title";this_obj.classList.contains("caption")&&(a="caption"),(r=document.createElement("ol")).setAttribute("id","edit_menu"),r.setAttribute("class","edit_menu"),editorLog("this_obj",this_obj),editorLog("this_obj.innerHTML",this_obj.innerHTML),editorLog("menu only?",'<div id="edit_menu_holder" class="edit_menu_holder" tabindex="-1"></div>'==this_obj.innerHTML),this_obj_parent_id=this_obj.parentElement.parentElement.id,this_obj_environment=internalSource[this_obj_parent_id].sourcetag,'<div id="edit_menu_holder" class="edit_menu_holder" tabindex="-1"></div>'==this_obj.innerHTML?r.innerHTML='<li id="choose_current" tabindex="-1" data-action="change-'+a+'">Add a '+a+"</li>":r.innerHTML='<li id="choose_current" tabindex="-1" data-action="change-'+a+'">Change '+a+"</li>",r.setAttribute("data-location","inline")}else if(this_obj.classList.contains("placeholder")&&(this_obj.classList.contains("hint")||this_obj.classList.contains("answer")||this_obj.classList.contains("solution")||this_obj.classList.contains("proof"))){var s="add",d=this_obj.getAttribute("data-HAS");r.setAttribute("id","choose_current"),r.setAttribute("data-env",d),r.setAttribute("data-parent_id",this_obj.getAttribute("data-parent_id")),r.innerHTML="<b>"+s+"</b> "+d}else this_obj.classList.contains("workspace")?(r.setAttribute("id","choose_current"),r.setAttribute("data-env","workspace"),r.setAttribute("data-action","modify"),r.setAttribute("data-parent_id",this_obj.getAttribute("data-parent_id")),r.innerHTML="<b>adjust</b> workspace"):(next_editable_of(this_obj,"children").length&&"P"!=this_obj.tagName?(editorLog("this_obj",this_obj),r.innerHTML=n==top_level_id?"<b>enter</b> this "+internalSource[this_obj.id].sourcetag+"?":"<b>enter</b> this "+internalSource[this_obj.id].sourcetag+", or add near here?"):r.innerHTML="<b>edit</b> this passage, or add near here?",r.setAttribute("data-location","next"));else r.setAttribute("data-location","stay"),r.innerHTML="continue editing this "+internalSource[this_obj.id].sourcetag;editorLog("edit_option",r),document.getElementById("edit_menu_holder").insertAdjacentElement("afterbegin",r),document.getElementById("edit_menu_holder").focus()}function next_editable_of(e,t){var i;return editorLog("finding",t,"editable of",e),"children"==t?i=$(e).find(" > [data-editable], > .sidebyside > .sbsrow > [data-editable],  > li > [data-editable], > .heading > [data-editable], > .hint > [data-editable], > .answer > [data-editable]"):"outer-block"==t?i=$(e).find(" > [data-editable]"):"inner-block"==t?i=$(e).find('section > [data-editable], [data-editable="99"], [data-editable="42"]'):"li-only"==t?i=$(e).find("li"):editorLog("unimplemented next_editable_of"),editorLog("next_to_edit",i),i}function create_new_internal_object(e,t,i){var n={"xml:id":t,sourcetag:e,parent:i,title:""};if(editorLog("create new internal object",e,"new_id",t,"parent_description",i),editorLog("within",internalSource[i[0]]),e.startsWith("sbs")){n.sourcetag="sidebyside";var o=e.split("_"),[r,a]=[o[1],o[o.length-1]];editorLog("sbs side margins",r,"jj",a),n.marginleft=r,n.marginright=a;for(var s="",d=[],c=2;c<=o.length-2;++c){d.push(o[c]);var l=randomstring();s+="<&>"+l+"<;>",internalSource[l]={"xml:id":l,sourcetag:"sbspanel",content:"",parent:[t,"content"]}}n.widths=d,n.content=s,editorLog("new sbs",n)}else{editorLog("new_tag",e);var _=objectStructure[e],g={};if(!_)return errorLog(e+" not implemented yet"),"";if("owner"in _)g=objectStructure[_.owner].source;var u=Object.assign({},g,_.source);if(editorLog("thissourcestructure",u),"attributes"in u){these_source_attributes=u.attributes;for(c=0;c<these_source_attributes.length;++c)editorLog("adding",c,"attribute",these_source_attributes[c]),n[these_source_attributes[c][0]]=these_source_attributes[c][1]}var m=u.pieces;for(c=0;c<m.length;++c){editorLog("adding a piece",m[c]);var[p,h]=m[c];if(h){var b=randomstring();n[p]="<&>"+b+"<;>",create_new_internal_object(h,b,[t,p])}else n[p]=""}}return editorLog("made the new_source",n),internalSource[t]=n,editorLog("parent_description",i,"new_tag",e,"new_id",t),editorLog("internalSource",internalSource),"list"==e||"p"==tag_type(e)||"source"==e||(e.startsWith("sbs")?ongoing_editing_actions.push(["new","sbs",t]):ongoing_editing_actions.push(["new",e,t])),e}function show_source(e,t){var i=document.createElement("span");i.setAttribute("id","newsource"),e.insertAdjacentElement(t,i),editorLog("just added",i);var n=output_from_id("",top_level_id,"pretext");n=(n=(n=n.replace(/\n\n/g,"\n")).replace(/ xml:id="tMP[0-9a-z]+"/g,"")).replace(/^ +$/gm,""),i.insertAdjacentHTML("afterend",'<textarea id="newpretextsource" style="width: 100%; height:30em">'+n+"</textarea>")}function save_source(){editorLog("         QQ  saving");var e=output_from_id("",top_level_id,"pretext");e=(e=(e=e.replace(/\n\n/g,"\n")).replace(/ xml:id="tMP[0-9a-z]+"/g,"")).replace(/^ +$/gm,""),editorLog("         RR  saving",top_level_id,"which begins",e.substring(0,50)),parent.save_file(top_level_id,e)}function create_object_to_edit(e,t,i){editorLog("create object to edit",e,t,i);var n=randomstring();recent_editing_actions.push(["new",e,n]);var o,r,a=document.createElement("span");a.setAttribute("id",n),"li"==e&&(t=t.parentElement),["hint","answer","solution","proof"].includes(e)?(r=[o=t.parentElement.id,e],editorLog(e,"parent_description",r),s=""):t.classList.contains("sbspanel")?(o=t.id,editorLog("special case for empty sbspanel",o),r=[o,"content"],s=""):(editorLog("new_objects_sibling",t),o=t.id,r=internalSource[o].parent,s=new RegExp("(<&>"+o+"<;>)"));var s=new RegExp("(<&>"+o+"<;>)");if("task"!=e||t.classList.contains("task")||(i="atend",r=[o,"tasks"]),["hint","answer","solution","proof"].includes(e)&&(i="replace"),editorLog(e,"parent_description",r),!create_new_internal_object(e,n,r))return"";var d=internalSource[r[0]][r[1]];editorLog("         the_current_arrangement",d),editorLog("         from parent_description",r,"internalSource[parent_description[0]]",internalSource[r[0]]),editorLog("    current_editing",current_editing);var c="",l=current_editing.level,_=current_editing.location[l];return editorLog("  UUU  current_editing",current_editing.level,current_editing.location.length,current_editing.tree.length,current_editing.tree[current_editing.level]),"beforebegin"==i||"afterbegin"==i?c="<&>"+n+"<;>$1":"afterend"!=i&&"beforeend"!=i||(c="$1<&>"+n+"<;>",_+=1),editorLog("makking new_arrangement from",s,"by",c),new_arrangement="atend"==i||"replace"==i?d+"<&>"+n+"<;>":d?d.replace(s,c):"<&>"+n+"<;>",editorLog("which became",new_arrangement),internalSource[r[0]][r[1]]=new_arrangement,"list"==e||(current_editing.location[l]=_),editorLog("         new_arrangement",new_arrangement),editorLog("tried to insert",n,"next to",o,"in",d),editorLog("    updated current_editing",current_editing),editorLog("  VVV  current_editing",current_editing.level,current_editing.location.length,current_editing.tree.length,current_editing.tree[current_editing.level]),editorLog("relative_placement",i,"edit_placeholder",a),"atend"==i?t.insertAdjacentElement("beforeend",a):"replace"==i?t.replaceWith(a):t.insertAdjacentElement(i,a),a}function edit_in_place(e,t){var i;if(editorLog("in edit in place",e),!(i=e.getAttribute("id")))return e.classList.contains("heading")?(editorLog("changing a heading"),editorLog("except we don;t know how to do that")):errorLog("error:  I don't know how to edit",e),"";if(editorLog("will edit in place id",i,"which is",e),thisTagName=e.tagName.toLowerCase(),internalSource[i]){var n=internalSource[i].sourcetag,o=i;if(editorLog("new_tag is",n,"from thisID",i,"from",internalSource[i]),"p"==tag_type(n)||"md"==tag_type(n)){(s=document.createElement("div")).setAttribute("id","actively_editing"),s.setAttribute("data-age",t),editorLog("thing with thisID",i,"is",document.getElementById(i)),$("#"+i).replaceWith(s);var r="editing_input_text",a=document.createElement("div");a.setAttribute("contenteditable","true"),"md"==tag_type(n)?a.setAttribute("class","text_source displaymath_input"):a.setAttribute("class","text_source paragraph_input"),a.setAttribute("id",r),a.setAttribute("data-source_id",i),a.setAttribute("data-parent_id",internalSource[i].parent[0]),a.setAttribute("data-parent_component",internalSource[i].parent[1]),document.getElementById("actively_editing").insertAdjacentElement("afterbegin",a),editorLog("setting",$("#"+r),"to have contents",internalSource[i].content),$("[contenteditable]").on("paste",function(e){e.preventDefault();var t=(e.originalEvent||e).clipboardData.getData("text/plain")||prompt("Paste something..");document.execCommand("insertText",!1,t)}),the_contents=internalSource[i].content,the_contents=expand_condensed_source_html(the_contents,"edit"),the_contents=the_contents.replace(/\\cr/g,"<div><br></div>"),$("#"+r).html(the_contents),document.getElementById(r).focus(),editorLog("made edit box for",i),editorLog("which is",document.getElementById(r)),editorLog("Whth content CC"+document.getElementById(r).innerHTML+"DD"),editorLog("Whth content EE"+document.getElementById(r).innerText+"FF"),editorLog("Whth content GG"+document.getElementById(r).textContent+"HH"),this_char="",prev_char=""}else if("image"==n){var s;(s=document.createElement("div")).setAttribute("id","actively_editing"),s.setAttribute("data-age",t),s.setAttribute("style","width:50%; margin-left:auto; margin-right: auto; padding: 2em 3em 3em 3em; background: #fed"),$("#"+i).replaceWith(s);r="editing_input_image";var d=document.createElement("div");d.setAttribute("contenteditable","true"),d.setAttribute("class","image_source"),d.setAttribute("id",r),d.setAttribute("style","background: #fff"),d.setAttribute("data-source_id",i),d.setAttribute("data-parent_id",internalSource[i].parent[0]),d.setAttribute("data-parent_component",internalSource[i].parent[1]),document.getElementById("actively_editing").insertAdjacentElement("afterbegin",d);var c=document.createElement("span");c.setAttribute("style","font-size: 90%"),c.innerHTML="URL of image:",document.getElementById("actively_editing").insertAdjacentElement("afterbegin",c),document.getElementById(r).focus(),editorLog("made edit box for",i),editorLog("which is",document.getElementById(r)),editorLog("Whth content CC"+document.getElementById(r).innerHTML+"DD"),editorLog("Whth content EE"+document.getElementById(r).innerText+"FF"),editorLog("Whth content GG"+document.getElementById(r).textContent+"HH"),this_char="",prev_char=""}else{editorLog(n,"create the object, then edit p in place",e);var l=html_from_internal_id(o,""),_=document.getElementById(i);_.insertAdjacentHTML("afterend",l[0]),_.remove();var g=document.getElementById(i);if(editorLog("added this_object",l),editorLog("where it is",g),"sidebyside"==internalSource[i].sourcetag){editorLog("added an sbs",document.getElementById(i)),editorLog("its .firstChild",document.getElementById(i).firstElementChild),editorLog("its .firstChild.firstchild",document.getElementById(i).firstElementChild.firstElementChild);var u=document.getElementById(i).firstElementChild.firstElementChild.id;editorLog("first_panel_id",u,document.getElementById(u)),make_current_editing_tree_from_id(u),edit_menu_from_current_editing("entering")}else{var m=$(g).find("p");m[0]?(editorLog("found the empty p",m),editorLog("found the empty p[0]",m[0]),edit_in_place(m[0],"new")):errorLog("error:  no empty p to edit")}}}else editorLog("Error: edit in place of object that is not already known",e),editorLog("What is known:",internalSource)}function resume_editing(){replace_by_id((internalSource=previous_editing()).root_data.id,"html"),edit_menu_for(top_level_id,"entering")}function replace_by_id(e,t){if("html"!=t)return"";output_from_id("",e,t);MathJax.typesetPromise(),window.setTimeout(adjustWorkspace,1e3)}function modify_by_id(e,t){editorLog("modifying by id",e),"sbspanel"==internalSource[e].sourcetag?modify_by_id_sbs(e,t):environment_instances["project-like"].includes(internalSource[e].sourcetag)||"task"==internalSource[e].sourcetag?modify_by_id_workspace(e,t):modify_by_id_image(e,t),save_edits()}function modify_by_id_workspace(e,t){var i=internalSource[e].workspace;editorLog("the_height",i,"from",internalSource[e]),i=parseInt(i),editorLog("the_height, ",i),"enlarge"==t?i+=10:"shrink"==t?i-=10:"enlargeslightly"==t?i+=1:"shrinkslightly"==t&&(i-=1),i<0&&(i=0),internalSource[e].workspace=i,editorLog("the_height is now",i);var n=document.getElementById(e).querySelector(".workspace");n.setAttribute("style","height:"+10*i+"px"),n.setAttribute("data-space",i)}function modify_by_id_image(e,t){var i=internalSource[e].width,n=internalSource[e].marginleft,o=internalSource[e].marginright;editorLog("width, , marginright, , marginleft",i,"mr",o,"ml",n),i=parseInt(i),o=parseInt(o),n=parseInt(n);var r=1,a=1;if("shrink"==t?r=-1:"left"==t&&(a=-1),"enlarge shrink".includes(t)){if(i>=100&&1==r||i<=0&&-1==r)return void editorLog("can't go above 100 or below 0");i+=2*r*magnify_scale,n>0&&o>0?(n+=-1*r*magnify_scale,o+=-1*r*magnify_scale):n>0?n+=-2*r*magnify_scale:o>0?o+=-2*r*magnify_scale:r<0?(n+=-1*r*magnify_scale,o+=-1*r*magnify_scale):editorLog("already have no margins, width is",i)}else"left right".includes(t)&&(editorLog("marginleft*moving_direction",n*a,"marginright*moving_direction",o*a),n>0&&o>0||o*a>0||n*a<0?(n+=a*move_scale,o+=-1*a*move_scale):editorLog("already at 100%, width is",i));var s="width: "+i+"%;";s+="margin-right: "+o+"%;",s+="margin-left: "+n+"%;",internalSource[e].width=i,internalSource[e].marginleft=n,internalSource[e].marginright=o,document.getElementById(e).setAttribute("style",s)}function modify_by_id_sbs(e,t){var i=internalSource[e].parent[0],n=internalSource[i];editorLog("this_sbs_source",n);var o=parseInt(n.marginleft),r=parseInt(n.marginright),a=n.content;a=(a=(a=a.replace(/^\s*<&>\s*/,"")).replace(/\s*<;>\s*$/,"")).replace(/>\s*</g,"><"),editorLog("these_siblings",a);var s=a.split("<;><&>"),d=s.indexOf(e);editorLog("this panel",e,"is",d,"within",s);var c=n.widths,l=parseInt(c[d]),_=0;editorLog("these html siblings",document.getElementById(s[0])," and ",document.getElementById(s[1])),editorLog("these siblings source",internalSource[s[0]],"and",internalSource[s[1]]);for(var g=0;g<s.length;++g){var u=parseInt(c[g]);c[g]=u,editorLog("adding width",u),_+=u}editorLog("occ",o,"u",_,"pi",r,"total",o+_+r,"ratio",r/_);var m=100-(o+_+r);editorLog("remaining_space",m),editorLog("width",l,"mr",r,"ml",o),editorLog("modifier",t);if("enlargeall"==t)if(editorLog("enlarging all","remaining space",m),m>=c.length)for(g=0;g<c.length;++g)c[g]+=1;else if(m+o+r>=c.length){for(g=0;g<c.length;++g)c[g]+=1;for(var p=c.length-m;p;)(p-=1)%2?o?o-=1:r-=1:r?r-=1:o-=1}else editorLog("Problem: not implemented yet");else if("shrinkall"==t)for(g=0;g<c.length;++g)c[g]&&(c[g]-=1);else"enlarge"==t?(editorLog("enlarging one"),m&&(c[d]+=1)):"shrink"==t?(editorLog("shrinking one"),c[d]&&(c[d]-=1)):"leftplus"==t?m&&(o+=1):"leftminus"==t?o&&(o-=1):"rightplus"==t?m&&(r+=1):"rightminus"==t&&r&&(r-=1);editorLog("now these_panel_widths",c),internalSource[i].marginleft=o,internalSource[i].marginright=r,internalSource[i].widths=c,document.getElementById(e).parentElement.style.marginLeft=o+"%",document.getElementById(e).parentElement.style.marginRight=r+"%";for(g=0;g<s.length;++g){var h=s[g],b=rescale(c[g],100,o,r);document.getElementById(h).style.width=b+"%"}editorLog("NOW these html siblings",document.getElementById(s[0])," and ",document.getElementById(s[1])),editorLog("NOW these siblings source",internalSource[s[0]],"and",internalSource[s[1]]),editorLog("and internalSource[this_id]",internalSource[h]),editorLog("and also internalSource[this_sbs_id]",internalSource[i])}function move_by_id_local(e,t){first_move=!0,document.getElementById("edit_menu_holder").remove(),document.getElementById(e).classList.remove("may_select"),moved_content=internalSource[e],moved_content_tag=moved_content.sourcetag,ongoing_editing_actions.push(["moved",moved_content_tag,e]),moved_parent_and_location=moved_content.parent,editorLog("moving",e),editorLog("moved_parent_and_location",moved_parent_and_location);var i=internalSource[moved_parent_and_location[0]][moved_parent_and_location[1]];editorLog("where_it_was",i);var n="<&>"+e+"<;>",o=i.replace(n,"");editorLog("where_it_is ZZ"+o+"EE"),internalSource[moved_parent_and_location[0]][moved_parent_and_location[1]]=o,moving_object=document.getElementById(e),editorLog("moving",moving_object,"within this page"),editorLog("moving_id",e),editorLog("current_editing[tree][0]",current_editing.tree[0]),"li"==moved_content_tag?movement_location_neighbors=next_editable_of(current_editing.tree[0][0],"li-only"):"p"==tag_type(moved_content_tag)?movement_location_neighbors=next_editable_of(current_editing.tree[0][0],"inner-block"):movement_location_neighbors=next_editable_of(current_editing.tree[0][0],"outer-block"),editorLog("movement_location_neighbors",movement_location_neighbors);for(var r=!1,a=0,s=0;s<movement_location_neighbors.length;++s)if(movement_location_neighbors[s]==moving_object){a=s,movement_location_neighbors.splice(s,1),r=!0;break}r||errorLog("serious error:  trying to move an object that is not movable",e),editorLog("movement_location_tmp",a),movement_location_options=[[movement_location_neighbors[0],"beforebegin"],[movement_location_neighbors[0],"afterend"]],movement_location=0;var d=1;for(s=1;s<movement_location_neighbors.length;++s)a==s&&(movement_location=d),d+=1,movement_location_neighbors[s-1].parentElement==movement_location_neighbors[s].parentElement||(d+=1,movement_location_options.push([movement_location_neighbors[s],"beforebegin"])),movement_location_options.push([movement_location_neighbors[s],"afterend"]);editorLog("movement_location_ct",d),editorLog("movement_location",movement_location),editorLog("made",movement_location_options.length,"movement_location_options",movement_location_options),editorLog("from",movement_location_neighbors.length,"movement_location_neighbors",movement_location_neighbors);var c=document.createElement("div");c.setAttribute("id","phantomobject"),c.setAttribute("data-moving_id",e),c.setAttribute("data-handle_id",t),c.setAttribute("class","phantomobject move"),c.setAttribute("tabindex","-1");var l='<div class="movearrow"><span class="arrow">&uarr;</span><p class="up">"shift-tab", or "up arrow", to move up</p></div>';l+='<div class="movearrow"><p class="done">"return" or "escape" to set in place </p></div>',
l+='<div class="movearrow"><span class="arrow">&darr;</span><p class="down">"tab" or "down arrow" to move down</p></div>',c.innerHTML=l;var _=moving_object;if("p"==tag_type(moved_content_tag)&&"li"==internalSource[moved_parent_and_location[0]].sourcetag&&1==moving_object.parentElement.getElementsByTagName("p").length){_=moving_object.parentElement;var g=moved_parent_and_location[0];editorLog("list item now empty:",g);var u=internalSource[g].parent;n="<&>"+g+"<;>",o=(i=internalSource[u[0]][u[1]]).replace(n,"");delete internalSource[g],editorLog("where_it_is II"+o+"OO"),internalSource[u[0]][u[1]]=o}_.replaceWith(c),document.getElementById("phantomobject").focus()}function move_object(e){if(editorLog("movement_location",movement_location),"Tab"==e.code&&e.shiftKey||"ArrowUp"==e.code)e.preventDefault(),0==movement_location?alert("can't move past the top"):(first_move&&(first_move=!1),movement_location-=1);else if("Tab"!=e.code&&"ArrowDown"!=e.code||e.shiftKey){if("Escape"==e.code||"Enter"==e.code||"ArrowRight"==e.code){e.preventDefault(),editorLog(" decided where to put moving_object",moving_object);var t=document.getElementById("phantomobject").getAttribute("data-moving_id");editorLog("moving object started as",internalSource[t]);var i=document.getElementById("phantomobject").getAttribute("data-handle_id");document.getElementById("phantomobject").remove();var n=movement_location_options[movement_location];editorLog("new_location_anchor",n),n[0].insertAdjacentElement(n[1],moving_object);var o=n[0].id;editorLog("new_neighbor_id",o),editorLog("which has source",internalSource[o]);var r=n[1],[a,s]=internalSource[o].parent,d=internalSource[a][s];editorLog("new_neighbor_in_context was",d);var c="<&>"+o+"<;>",l=new RegExp(c),_="<&>"+t+"<;>";d="beforebegin"==r?d.replace(l,_+"\n"+c):d.replace(l,c+"\n"+_),editorLog("new_neighbor_in_context is",d),internalSource[a][s]=d,internalSource[t].parent=[a,s],editorLog("moving object ended as",internalSource[t]),save_edits(),make_current_editing_tree_from_id(i);var g=ongoing_editing_actions.pop();return recent_editing_actions.unshift(g),void edit_menu_from_current_editing("entering")}editorLog("don't know how to move with",e.code)}else e.preventDefault(),first_move&&(first_move=!1,editorLog("did first move")),movement_location==movement_location_options.length-1?alert("can't move past the bottom"):movement_location+=1;editorLog("now movement_location",movement_location);var u=document.getElementById("phantomobject");movement_location_options[movement_location][0].insertAdjacentElement(movement_location_options[movement_location][1],u),document.getElementById("phantomobject").focus()}function delete_by_id(e,t){final_added_object="",editorLog("deleting by theid",e,"with content",internalSource[e]);var i=internalSource[e],n=i.parent;delete internalSource[e],editorLog("deleted",e,"so",e in internalSource,"now",internalSource),e in old_content?old_content[e].push(i):old_content[e]=[i],"newempty"!=t&&ongoing_editing_actions.push(["deleted ",i.sourcetag,e]);var o=current_editing.level,r="<&>"+e+"<;>",a=internalSource[n[0]][n[1]].replace(r,"");if(editorLog("where_it_is ZZ"+a+"EE"),internalSource[n[0]][n[1]]=a,a.trim()||"content"!=n[1]&&"statement"!=n[1]){var s=current_editing.location[o]+1;"empty"==t||"newempty"==t?(editorLog("removing from DOM",document.getElementById(e)),document.getElementById(e).remove(),s-=1,editorLog("current_index",s,"current_level",o),editorLog(current_editing.tree[o]),s>current_editing.tree[o].length-1&&(s=current_editing.tree[o].length-1),current_editing.tree[o][s].id==e&&current_editing.tree[o].splice(s,1),editorLog("empty or newempty",t)):(editorLog("deleting for another reason",t),document.getElementById("edit_menu_holder").remove(),document.getElementById(e).setAttribute("id","deleting"),document.getElementById("deleting").removeAttribute("data-editable"),setTimeout(()=>{document.getElementById("deleting").remove()},600)),s>=current_editing.tree[o].length&&(s=current_editing.tree[o].length-2),editorLog("current_index",s,"in",current_editing.tree[o]),editorLog("object of interest",current_editing.tree[o][s]),editorLog("current_level",o,"on",current_editing.tree),make_current_editing_tree_from_id(current_editing.tree[o][s].id),edit_menu_from_current_editing("entering")}else editorLog("      deleted from within",internalSource[n[0]]),document.getElementById(e).removeAttribute("data-editable"),"li"==internalSource[n[0]].sourcetag?editorLog("not going up a level, because it is a list element"):current_editing.level-=1,delete_by_id(n[0],t);save_edits()}function create_local_menu(){editorLog("make local edit menu for",this_obj_id);var e=document.createElement("div");e.setAttribute("id","local_menu_holder"),e.setAttribute("tabindex","-1"),editorLog("adding local menu for",this_obj_id),document.getElementById(this_obj_id).insertAdjacentElement("afterbegin",e);var t=document.createElement("ol");t.setAttribute("id","edit_menu"),t.setAttribute("class","edit_menu"),t.innerHTML=menu_options_for(this_obj_id,"XunusedX","base"),document.getElementById("local_menu_holder").insertAdjacentElement("afterbegin",t)}function extract_internal_contents(e){the_text=e,editorLog("            xxxxxxxxxx  the_text is",the_text),editorLog("extract_internal_contents"),the_text=the_text.replace(/ class="[^"]"/g,""),editorLog("extracting where 'data-editable...'"),the_text=the_text.replace(/<([^<]+) data-editable="[^"]+" tabindex="-1">(.*?)<[^<]+>/g,save_internal_cont),editorLog("extracting where 'contenteditable...'"),the_text=the_text.replace(/<([^<]+) contenteditable="false">(.*?)<[^<]+>/g,save_internal_cont),editorLog("extracting new $math$"),the_text=the_text.replace(/(^|\s)\$([^\$]+)\$(\s|$|[.,!?;:])/gm,extract_new_math),editorLog("extracting new \\(math\\)"),the_text=the_text.replace(/(^|.)\\\(([^\$]+)\\\)(.|$)/g,extract_new_math),editorLog("extracting new <m>math</m>"),the_text=the_text.replace(/(^|.)&lt;m&gt;(.*?)&lt;\/m&gt;(.|$)/g,extract_new_math),the_text=the_text.replace(/\.\.\./g,"&lt;ellipsis/&gt;"),the_text=the_text.replace(/(\s)etc\.?([^a-zA-Z])/g,"$1&lt;etc/&gt;$2");for(var t=0;t<inline_abbrev.length;++t){var i=inline_abbrev[t];editorLog("this_tag",i);var n="&lt;("+i+")\\/&gt;";editorLog("searching for",n);var o=new RegExp(n,"g");the_text=the_text.replace(o,extract_new_inline)}the_text=the_text.replace(/(^|\s)"([^"]+)"(\s|$|[.,!?;:])/g,"$1&lt;q&gt;$2&lt;/q&gt;$3"),the_text=the_text.replace(/(^|\s)\u201c([^\u201d]+)\u201d(\s|$|[.,!?;:])/g,"$1&lt;q&gt;$2&lt;/q&gt;$3"),the_text=the_text.replace(/(^|\s)\u2018([^\u2019]+)\u2019(\s|$|[.,!?;:])/g,"$1&lt;q&gt;$2&lt;/q&gt;$3");for(t=0;t<inline_tags.length;++t){i=inline_tags[t];editorLog("this_tag",i);n="&lt;("+i+") *&gt;(.*?)&lt;\\/"+i+"&gt;";editorLog("searching for",n);o=new RegExp(n,"g");the_text=the_text.replace(o,extract_new_inline)}return the_text}function extract_new_math(e,t,i,n){var o=randomstring();return internalSource[o]={"xml:id":o,sourcetag:"m",content:i},t+"<&>"+o+"<;>"+n}function extract_new_inline(e,t,i){var n=randomstring();return editorLog("extracting",i,"inside",t),internalSource[n]={"xml:id":n,sourcetag:t,content:i},"<&>"+n+"<;>"}function extract_new_abbrev(e,t){var i=randomstring();return editorLog("extracting",the_content,"inside",t),internalSource[i]={"xml:id":i,sourcetag:t},"<&>"+i+"<;>"}function save_internal_cont(e,t,i){return this_id=t.replace(/.*id="(.+?)".*/,"$1"),editorLog("id",this_id,"now has contents",i),"content"in internalSource[this_id]?internalSource[this_id].content=i:"xref"==internalSource[this_id].sourcetag&&(internalSource[this_id].ref=i),editorLog("all of it is now",internalSource[this_id]),"<&>"+this_id+"<;>"}function assemble_internal_version_changes(e){editorLog("in assemble_internal_version_changes"),editorLog("current active element to be saved",e),editorLog("which has parent",e.parentElement),editorLog("whose age is",e.parentElement.getAttribute("data-age"));var t=e.parentElement.getAttribute("data-age");t||(t=e.getAttribute("data-age")),editorLog("    OLDorNEW",t);var i=[],n="",o=e.parentElement,r="";if(e.classList.contains("paragraph_input")){editorLog("found paragraph_input"),n="replace",h=(h=e.innerHTML).trim();var a=e.selectionStart;editorLog("cursor_location",a,"out of",h.length,"paragraph_content",h);var s=[e.getAttribute("data-parent_id"),e.getAttribute("data-parent_component")];editorLog("parent_and_location",s),editorLog("of ",e);var d=e.getAttribute("data-source_id");editorLog("prev_id",d),editorLog("which contains",internalSource[d]);var c=h.split("<div><br></div>");editorLog("there were",c.length,"paragraphs, but some may be empty");for(var l=0;l<c.length;++l)editorLog("paragraph",l,"begins",c[l].substring(0,20));var _=[];for(l=0;l<c.length;++l){var g=c[l];(g=(g=(g=(g=(g=(g=(g=g.replace(/<\/div><div>/g,"\n")).replace(/<div>/g,"")).replace(/<\/div>/g,"")).replace(/&nbsp;/g," ")).replace(/ +<br>/g,"\n")).replace(/<br>/g,"\n")).trim())?_.push(g):editorLog("empty paragraph"),editorLog("done transforming paragraph",l,"with object_being_edited",e),editorLog("which has contents",g)}_.length||(_=[""]);for(l=0;l<_.length;++l)editorLog("_trimmed paragraph",l,"begins",_[l].substring(0,20));for(l=0;l<_.length;++l){var u=_[l];if(editorLog("this_paragraph_contents",u.substring(0,20)),0==l&&d)d in internalSource?(u=extract_internal_contents(u),internalSource[d].content!=u?(internalSource[d].content?ongoing_editing_actions.push(["changed","p",d]):u&&ongoing_editing_actions.push(["new","p",d]),internalSource[d].content=u,editorLog("changed content of",d)):u||ongoing_editing_actions.push(["empty","p",d]),i.push([d,"content",t]),r=internalSource[s[0]][s[1]]):errorLog("error:  existing tag from input",d,"not in internalSource");else{var m={sourcetag:"p",title:""};this_object_label=randomstring(),m["xml:id"]=this_object_label,m.parent=s;var p=new RegExp("(<&>"+d+"<;>)");r=r.replace(p,"$1\n<&>"+this_object_label+"<;>"),d=this_object_label,u=extract_internal_contents(u),m.content=u,internalSource[this_object_label]=m,editorLog("just inserted at label",this_object_label,"content starting",u.substring(0,11),"which is now",internalSource[this_object_label]),ongoing_editing_actions.push(["added","p",this_object_label]),i.push([this_object_label,"content","new"])}}editorLog("parent_and_location",s),editorLog("this_arrangement_of_objects was",internalSource[s[0]][s[1]]),internalSource[s[0]][s[1]]=r,editorLog("this_arrangement_of_objects is",r)}else if(e.classList.contains("displaymath_input")){var h;editorLog("found displaymath_input"),n="replace",h=(h=e.innerHTML).trim();a=e.selectionStart;editorLog("cursor_location",a,"out of",h.length,"paragraph_content",h);s=[e.getAttribute("data-parent_id"),e.getAttribute("data-parent_component")];editorLog("parent_and_location",s),editorLog("of ",e);d=e.getAttribute("data-source_id");editorLog("prev_id",d),editorLog("which contains",internalSource[d]),u=extract_internal_contents(u=(c=split_paragraphs(h)).join("\n\\cr\n")),internalSource[d].content?ongoing_editing_actions.push(["changed","md",d]):ongoing_editing_actions.push(["new","md",d]),internalSource[d].content=u,i.push([d,"content",t])}else if("title"==e.getAttribute("data-component")||"caption"==e.getAttribute("data-component")){var b=e.getAttribute("data-component");n="replace",y=(y=e.innerHTML).trim(),editorLog("the content (is it a title or caption?) is",y);var f=e.getAttribute("data-source_id"),v=e.getAttribute("data-component");editorLog("component_being_changed",v,"within",f),internalSource[f][v]?ongoing_editing_actions.push(["changed",b,f]):ongoing_editing_actions.push(["added",b,f]),internalSource[f][v]=y,i.push([f,b])}else if(e.classList.contains("image_source")){var L=e.innerHTML;L=(L=(L=L.replace(/<div>/g,"")).replace(/<\/div>/g,"")).trim(),editorLog("changing image src to",L);var x=e.getAttribute("data-source_id");editorLog("image_being_changed ",x),internalSource[x].source?ongoing_editing_actions.push(["changed","source",x]):ongoing_editing_actions.push(["added","source",x]),internalSource[x].source=L,editorLog("image being changed is",internalSource[x]),i.push([x,"image"])}else{if(inline_tags.includes(e.tagName.toLowerCase()))return editorLog(e,"is inline, so processing parent"),assemble_internal_version_changes(e.parentElement);if(e.classList.contains("edit_math_row")){var y;n="replace",y=(y=e.innerHTML).trim(),editorLog("the content (is it a title?) is",y);f=e.getAttribute("id"),v="content";editorLog("component_being_changed",v,"within",f),internalSource[f][v]?ongoing_editing_actions.push(["changed","mrow",f]):ongoing_editing_actions.push(["added","mrow",f]),internalSource[f][v]=y,i.push([f,"mrow"])}else errorLog("trouble editing",e,"AAA",e.tagName.toLowerCase(),"not in",inline_tags),alert("don;t know how to assemble internal_version_changes of "+e.tagName)}return editorLog("finished assembling internal version, which is now:",internalSource),editorLog("    NUMBER of things chagnged:",i.length),[n,o,i]}function wrap_tag(e,t,i){if(!t&&!e)return"";if(!t&&!always_empty_tags.includes(e)&&!allowed_empty_tags.includes(e))return"";if(!e)return t;var n=closing_tag="";if("string"==typeof e){if(e){n="<"+e;for(var o=0;o<i.length;++o)n+=" "+i[o];closing_tag="</"+e+">"}t||!always_empty_tags.includes(e)&&!allowed_empty_tags.includes(e)?n+=">":(n+="/>",closing_tag=""),tag_display.inline.includes(e)||(tag_display.title.includes(e)?(n="\n"+n,closing_tag+="\n"):tag_display["block-tight"].includes(e)||(n="\n"+n+"\n",closing_tag&&(closing_tag="\n"+closing_tag+"\n")))}else if(e){[n,closing_tag]=e;for(o=0;o<i.length;++o)n+=" "+i[o]}else n="",closing_tag="";return n||(n=""),closing_tag||(closing_tag=""),t.includes("N.m")&&(editorLog("3 ----- content",t),editorLog("opening_tag",n)),n.startsWith("<p")&&!t&&alert("empty p"),n+t.trim()+closing_tag}function output_from_source(e,t,i){if(!e)return"";if(!t)return"MISSING STRUCTURE";editorLog("calling output from_source","the_object",e,"output_structure",t,"format",i);var n="",o=t.tag;o||(o=[t.tag_opening,t.tag_closing]);var r=[];r="attributes"in t&&t.attributes?t.attributes:[];for(var a=[],s=0;s<r.length;++s){var d=r[s];editorLog("attr_val",d),d=d.replace(/<&>(.*?)<;>/g,function(i,n){if(n.startsWith("{"))return(n=n.slice(1,-1))in t?t[n]:"";if(n.startsWith("(")){var o,r=n.slice(1,-1);return[o,r]=r.split(","),process_value_from_source(o,r,e)}return n in e?e[n]:""}),editorLog("         attr_val",d),d&&!d.includes('""')&&a.push(d)}editorLog("output_structure",o,"is",t),editorLog("output_attributes_values",a),editorLog("output_structure.pieces",t.pieces);for(s=0;s<t.pieces.length;++s){var c="",[l,_]=t.pieces[s];if(editorLog("output_structure",t),editorLog(s,"this_piece",l,"this_tag",_,"output_tag",o),l.startsWith("{"))l=l.slice(1,-1),c+=output_from_source(e,objectStructure[l][i],i),editorLog("wrapping in bracketed tag",_),n+=wrap_tag(_,c,[]);else if(l.startsWith("%"))l=l.slice(1,-1),editorLog("% % % % % % % % % ",l,"this_tag",_,"the_object",e),editorLog("% % % % % % % % % ",e[l]),editorLog("% % % % % % % % % ",e[_]),e[_]?(n+=c=expand_condensed_source_html(e[_],"html?"),editorLog("this piece exists",l,"this_piece_output",c)):(editorLog("making placeholder for",l),n+=wrap_tag("div","",['class="placeholder '+l+'"','data-parent_id="'+e["xml:id"]+'"','data-has="'+l+'"','tabindex="-1"','data-editable="123456"','data-placeholder=""']));else if(l.startsWith("(")){var g;editorLog("whole this_piece",l),l=l.slice(1,-1),[g,l]=l.split(",");var u=process_value_from_source(g,l,e);editorLog(s,"parenthesized content",u,"this_piece",l,"XX",_),n+=wrap_tag(_,u,[])}else l in e?(c=output_from_text(e[l],i),"pretext"==i&&"md"==o&&"content"==l&&(c="<mrow>\n"+(c=c.replace(/\s*\\cr\b\s*/g,"</mrow>\n<mrow>\n"))+"\n</mrow>"),n+=wrap_tag(_,c,[])):editorLog("missing piece:",_,"with no",l)}return"pretext"!=i||inline_tags.includes(o)||inline_math.includes(o)||(n=n.replace(/(^|\n)( *(\w|<))/g,"$1  $2")),n=wrap_tag(o,n,a)}function output_from_text(e,t){return editorLog("output_from_text of ",e,"with format",t),e.includes("<&>")?e.replace(/<&>(.*?)<;>/g,function(e,i){return output_from_id(e,i,t)}):e}function output_from_id(e,t,i){editorLog("expanding the_id",t),debugLog("expanding the_id",t);var n=internalSource[t];if(!n)return errorLog("error: no content for",t),t;var o,r=n.sourcetag;return editorLog("the_object",n),r in objectStructure?o=objectStructure[r][i]:(errorLog("error: unknown structure:",r),o={tag:r,pieces:[["content",""]]}),editorLog("output_structure",o),output_from_source(n,o,i)}function expand_condensed_source_html(e,t){return editorLog("iiiiiii     in expand_condensed_source_html"),e.includes("<&>")?(editorLog("     qqqqq      expand_condensed_source_html",e),"edit"==t?e.replace(/<&>(.*?)<;>/g,expand_condensed_src_edit):e.replace(/<&>(.*?)<;>/g,expand_condensed_src_html)):(editorLog("returning text XX"+e.substring(0,17)+"YY"),editorLog("returning from expand_condensed_source_html"),e)}function expand_condensed_src_html(e,t){return html_from_internal_id(t,"inner")}function expand_condensed_src_edit(e,t){return html_from_internal_id(t,"edit")}function html_from_internal_id(e,t){var i=internalSource[e];editorLog("making html of",i,"is_inner",t,"the_id",e);var n,o=i.sourcetag;editorLog("which has tag",o),editorLog("m in inline_math",inline_math.includes("m"));var r=[];if("image"==o)n=output_from_id("",e,"html"),editorLog("html_of_this_object",n),r.push(n);else if("p"==tag_type(o))n=output_from_id("",e,"html"),editorLog("html_of_this_object",n),r.push(n);else{if(inline_math.includes(o)&&"edit"==t){var a='<span class="edit_inline_math"',s="</span>";return(a+=' id="'+e+'"data-editable="44" tabindex="-1">')+spacemath_to_tex(i.content)+s}if(["me","men"].includes(o)&&"edit"==t){a='<div class="edit_display_math"',s="</div>";return(a+=' id="'+e+'"data-editable="44" tabindex="-1">')+spacemath_to_tex(i.content)+s}if(["md","mdn"].includes(o)&&"edit"==t){a='<div class="edit_multiline_math"',s="</div>";return a+=' id="'+e+'"data-editable="44" tabindex="-1">',this_content=i.content.replace(/<&>(.*?)<;>/g,expand_condensed_src_edit),this_content=this_content.replace("MROWsepARATOR","\n yyyy \n"),a+this_content+s}if(["mrow"].includes(o)&&"edit"==t){a='<div class="edit_math_row"',s="</div>";return(a+=' id="'+e+'"data-editable="44" tabindex="-1">')+"MROW"+spacemath_to_tex(i.content)+s}if("xref"==o&&"edit"==t){a='<span class="edit_reference"',s="</span>";return(a+=' id="'+e+'"data-editable="44" tabindex="-1">')+i.ref+s}n=output_from_id("",e,"html"),editorLog("html_of_this_object",n),r.push(n)}return editorLog("    RRRR returning the_html_objects",r),r}function insert_html_version(e){var t=e[0],i=e[1],n=e[2];editorLog("nature_of_the_change",t),editorLog("location_of_change",i),editorLog("possibly_changed_ids_and_entry",n),n.length||editorLog("nothing to change"),"replace"!=t&&editorLog("should be replace, since it is the edit form we are replacing");var o,r,a,s="";editorLog(" there are",n.length,"items to process");for(var d=0;d<n.length;++d){if(o=n[d][0],r=n[d][1],n[d][2],editorLog("j=",d,"this thing",n[d]),a=internalSource[o],editorLog(d,"this_object",a),"p"==tag_type(a.sourcetag)||"li"==a.sourcetag||"md"==tag_type(a.sourcetag)){var c=html_from_internal_id(o);editorLog("inserting",c,"before",i),i.insertAdjacentHTML("beforebegin",c[0]),s=document.getElementById(o)}else if("title"==r){(s=document.createElement("span")).setAttribute("class","title"),s.setAttribute("data-editable",20),s.setAttribute("tabindex",-1),s.innerHTML=a[r],editorLog("inserting",s,"before",i),i=i.querySelector("#actively_editing"),editorLog("now location_of_change",i),i.insertAdjacentElement("beforebegin",s)}else if("caption"==r);else if("image"==r){editorLog("image, this_object",a);c=html_from_internal_id(o);editorLog("inserting",c,"before",i),i.insertAdjacentHTML("beforebegin",c[0]),s=document.getElementById(o)}else editorLog("trouble making",a);MathJax.typesetPromise()}return i.remove(),editorLog("returning from insert html version",s),s}function save_edits(){var e=internalSource;return editorLog("saving",e),localStorage.setObject("savededits",e),""}function previous_editing(){return localStorage.getObject("savededits")||""}function local_editing_action(e){var t;if(editorLog("in local editing action for",e.code),"Escape"==e.code||"Enter"==e.code){if(editorLog("I saw a Rettttt"),"title"==document.activeElement.getAttribute("data-component")||"caption"==document.activeElement.getAttribute("data-component"))editorLog("probably saving a ",document.activeElement.getAttribute("data-component")),e.preventDefault(),these_changes=assemble_internal_version_changes(document.activeElement),final_added_object=insert_html_version(these_changes),t=ongoing_editing_actions.pop(),recent_editing_actions.unshift(t),editorLog("most_recent_edit should be title change",t),editorLog("final_added_object",final_added_object),this_char="",prev_char="",save_edits(),make_current_editing_tree_from_id(final_added_object.parentElement.parentElement.id),edit_menu_from_current_editing("entering");else if("Escape"==e.code||"Enter"==prev_char.code&&"Enter"==prev_prev_char.code||document.getElementById("editing_input_image")){if(editorLog("need to save"),editorLog("    HHH current_editing",current_editing,"with active element",document.activeElement),e.preventDefault(),this_char="",prev_char="",these_changes=assemble_internal_version_changes(document.activeElement),editorLog("    CCC these_changes",these_changes),editorLog("    CCC0 these_changes[0]",these_changes[0]),editorLog("ongoing_editing_actions",ongoing_editing_actions),editorLog("actively_editing",document.getElementById("actively_editing")),editorLog("    III current_editing",current_editing,current_editing.tree[current_editing.level]),previous_added_object=final_added_object,final_added_object=insert_html_version(these_changes),editorLog("final_added_object, previous_added_object",final_added_object,previous_added_object),editorLog("    LLL current_editing",current_editing,current_editing.tree[current_editing.level]),editorLog("the final_added_object",final_added_object),editorLog("the actively_editing",document.getElementById("actively_editing")),editorLog("OO",ongoing_editing_actions.length," ongoing_editing_actions",ongoing_editing_actions),"empty"==these_changes[0]){editorLog("NN",ongoing_editing_actions.length," ongoing_editing_actions",ongoing_editing_actions),editorLog("ongoing_editing_actions[0]",ongoing_editing_actions[0]),editorLog("ongoing_editing_actions[0][2]",ongoing_editing_actions[0][2]),editorLog("            going to delete",these_changes[2][0]),2==ongoing_editing_actions.length&&"empty"==ongoing_editing_actions[1][0]&&"p"==ongoing_editing_actions[1][1]&&"new"==ongoing_editing_actions[0][0]&&"li"==ongoing_editing_actions[0][1]?(ongoing_editing_actions.pop(),ongoing_editing_actions.pop(),delete_by_id(these_changes[2][0][0],"newempty"),current_editing.location[current_editing.level]-=1,final_added_object=previous_added_object):delete_by_id(these_changes[2][0][0],"empty"),editorLog("MM",ongoing_editing_actions.length," ongoing_editing_actions",ongoing_editing_actions);for(var i=0;i<ongoing_editing_actions.length;++i)editorLog(i,"ongoing_editing_actions[j]",ongoing_editing_actions[i]);editorLog("PP",ongoing_editing_actions.length," ongoing_editing_actions",ongoing_editing_actions)}if(final_added_object){if(document.getElementById("actively_editing")){editorLog("    SSS current_editing",current_editing,current_editing.tree[current_editing.level]);var n=document.getElementById("actively_editing");editorLog("still editing",n,"which contains",final_added_object);var o=internalSource[final_added_object.id].parent;editorLog("final_added_object parent",o);var r=html_from_internal_id(o[0]);if(editorLog("the_whole_object",r),"proof"==internalSource[o[0]].sourcetag)alert("something about a proof"),r=html_from_internal_id(internalSource[o[0]].parent[0]).concat(r);for(i=r.length-1;i>=0;--i)editorLog("   X",i,"the_whole_object[j]",r[i]),document.getElementById("actively_editing").insertAdjacentElement("afterend",r[i]),MathJax.typesetPromise();editorLog("here is where we need to update current_editing","parent:",o,"which is",document.getElementById(o[0]),"level:",current_editing.level,"loation:",current_editing.location,"tree:",current_editing.tree),$("#actively_editing").remove(),editorLog("    DDD current_editing",current_editing,current_editing.tree[current_editing.level])}for(t=["","",""];ongoing_editing_actions.length;)t=ongoing_editing_actions.pop(),recent_editing_actions.unshift(t),editorLog("      most_recent_edit",t);if(editorLog("     8888 final_added_object",final_added_object),save_edits(),editorLog("most_recent_edit",t),"li"==t[1])edit_in_place(create_object_to_edit("li",document.getElementById(t[2]).firstElementChild,"afterend"),"new"),editorLog("now editing the assumed new li"),editorLog("    GGG current_editing",current_editing,current_editing.tree[current_editing.level]);else editorLog("re-making the tree from final_added_object",final_added_object),make_current_editing_tree_from_id(final_added_object.id),editorLog("and then adding a menu"),edit_menu_from_current_editing("entering")}else document.getElementById("actively_editing")?(document.getElementById("actively_editing").remove(),edit_menu_from_current_editing("entering")):edit_menu_from_current_editing("entering")}editorLog("processed an enter")}else editorLog("e.code was not one of those we were looking for",e);editorLog("leaving local editing action")}function main_menu_navigator(e){if(document.getElementById("enter_choice")){theEnterChoice=document.getElementById("enter_choice"),editorLog("enter_choice",e);var t=theEnterChoice.getAttribute("data-location");_="stay"==t?theEnterChoice.parentElement.previousSibling:theEnterChoice.parentElement.parentElement,editorLog("      MMN: want to",t,"on",_,"from",theEnterChoice),editorLog("current_editing",current_editing),editorLog("theEnterChoice",theEnterChoice);var i=current_editing.level,n=current_editing.location[i],o=current_editing.tree[i];if(editorLog("current_level",i,"current_location",n,"current_siblings",o),"Tab"!=e.code&&"ArrowDown"!=e.code||e.shiftKey){if("Tab"==e.code&&e.shiftKey||"ArrowUp"==e.code)if(e.preventDefault(),editorLog("Arrow Up:","current_location",n,"current_level",i),"stay"==t)edit_menu_from_current_editing("entering");else if(0==n){if(!i)return editorLog("at the top, so can't go up"),"";i-=1,current_editing.level=i,n=current_editing.location[i],editorLog("AA new current_location",n," current_editing['tree']",current_editing.tree),editorLog(" current_editing['tree'][0]",current_editing.tree[0]),o=current_editing.tree[i],editorLog("current_siblings",o),edit_menu_from_current_editing("entering")}else n-=1,current_editing.location[i]=n,editorLog("current_siblings",o),editorLog("BB new current_location",n,"at level",i," current_editing['tree']",current_editing.tree),edit_menu_from_current_editing("entering");else if("Escape"==e.code||"ArrowLeft"==e.code){if(e.preventDefault(),0==i)return"";editorLog("At ArrowLeft, level was",i,"with location",current_editing.location,"and tree",current_editing.tree[i]),i-=1,current_editing.level=i,n=current_editing.location[i],o=current_editing.tree[i],editorLog("now level id",i,"with location",current_editing.location,"and tree",current_editing.tree[i]),edit_menu_from_current_editing("entering")}else if("Enter"==e.code||"ArrowRight"==e.code){if(e.preventDefault(),"stay"==t)return edit_menu_from_current_editing("entering"),"";(w=document.createElement("ol")).setAttribute("id","edit_menu"),w.setAttribute("class","edit_menu");var r=_;editorLog("to_be_edited",r),w.innerHTML=top_menu_options_for(r),$("#enter_choice").replaceWith(w),document.getElementById("choose_current").focus()}}else{if(e.preventDefault(),0==i)return"";n==o.length-1?(editorLog("on last sibling, level was",i,"siblings was",o,"tree",current_editing.tree),editorLog("current_location was",n),i-=1,n=current_editing.location[i],current_editing.level=i,current_editing.location[i]=n,o=current_editing.tree[i],editorLog("current_location is",n),editorLog("stay menu A"),_.classList.remove("may_leave"),_.classList.remove("may_elect"),edit_menu_from_current_editing("leaving")):(editorLog("moving to the next editable sibling"),editorLog("level was",i,"siblings was",o,"tree",current_editing.tree),editorLog("current_location was",n),editorLog(n,"was",current_editing),n+=1,_.classList.remove("may_leave"),_.classList.remove("may_elect"),editorLog("current_location is",n),editorLog("stay menu B"),current_editing.location[i]=n,editorLog(n,"is",current_editing),edit_menu_from_current_editing("entering"))}return editorLog("   Just handled the case of enter_choice"),""}if(document.getElementById("choose_current")){var a=document.getElementById("choose_current"),s=a.getAttribute("data-location"),d=a.getAttribute("data-action"),c=a.getAttribute("data-modifier"),l=a.getAttribute("data-env");"save"==l&&(d="save");var _,g=a.getAttribute("data-env-parent");if(document.getElementById("edit_menu_holder")?_=document.getElementById("edit_menu_holder").parentElement:document.getElementById("local_menu_holder")?_=document.getElementById("local_menu_holder").parentElement:(editorLog("something is confused:  should be a menu, but isn't"),a.id?(make_current_editing_tree_from_id(a.id),_=a):(make_current_editing_tree_from_id(a.parentElement.id),_=a.parentElement),editorLog("made entering menu for",_),edit_menu_from_current_editing("entering")),i=current_editing.level,n=current_editing.location[i],o=current_editing.tree[i],editorLog("in choose_current",s,"of",_),editorLog("dataAction ",d),editorLog("dataLocation ",s),"Tab"!=e.code&&"ArrowDown"!=e.code||e.shiftKey)if("Tab"==e.code&&e.shiftKey||"ArrowUp"==e.code)e.preventDefault(),editorLog("just saw a",e.code),editorLog("focus is on",$(":focus")),editorLog("saw an",e.code),next_menu_item=a.previousSibling,editorLog("W1 theChooseCurrent",a,"next_menu_item",next_menu_item),next_menu_item||(next_menu_item=a.parentNode.lastChild),editorLog("W2 theChooseCurrent",a,"next_menu_item",next_menu_item),a==next_menu_item?(0==current_editing.location[current_editing.level]?current_editing.level-=1:current_editing.location[current_editing.level]-=1,editorLog("single item menu, current_level now",i),edit_menu_from_current_editing("entering")):(a.removeAttribute("id"),editorLog("W3 theChooseCurrent",a,"next_menu_item",next_menu_item),a.classList.remove("chosen"),next_menu_item.setAttribute("id","choose_current"),editorLog("setting focus on",next_menu_item),next_menu_item.focus());else if("Escape"==e.code||"ArrowLeft"==e.code)if(editorLog("processing ESC"),editorLog("At ArrowLeft, level was",i,"xx",current_editing.level,"with location",current_editing.location,"and tree",current_editing.tree[i]),document.getElementById("local_menu_holder"))document.getElementById("local_menu_holder").remove();else{editorLog("W4 theChooseCurrent",a);var u=a.parentElement.parentElement;if("edit_menu_holder"==u.id){var m='<span id="enter_choice" data-location="next">';m+="edit or add nearby",m+="</span>",u.innerHTML=m}else a.parentElement.remove(),u.classList.remove("chosen"),u.parentElement.classList.remove("past"),u.setAttribute("id","choose_current"),u.focus()}else if(keyletters.includes(e.code))key_hit=e.code.toLowerCase().substring(3),editorLog("key_hit",key_hit),a=document.getElementById("choose_current"),editorLog("theChooseCurrent",a),editorLog($(a)),(next_menu_item=$(a).nextAll('[data-jump~="'+key_hit+'"]:first')[0])||(next_menu_item=$(a).prevAll('[data-jump~="'+key_hit+'"]:last')[0])?(a.removeAttribute("id","choose_current"),next_menu_item.setAttribute("id","choose_current"),next_menu_item.focus()):editorLog("that key does not match any option");else if("Enter"==e.code||"ArrowRight"==e.code){if(e.preventDefault(),s){if("enter"==s){editorLog("theChooseCurrent",a);var p=_;return editorLog("object_to_be_entered",p),p.classList.remove("may_select"),p.classList.remove("may_enter"),p.classList.remove("may_leave"),editorLog('next_editable_of(object_to_be_entered, "children")'),editableChildren=next_editable_of(p,"children"),i+=1,current_editing.level=i,current_editing.location[i]=0,current_editing.tree[i]=editableChildren,editorLog("current_editing",current_editing),editorLog("object_to_be_entered",p),editorLog("with some children",editableChildren),editorLog("menu place 10"),editorLog("document.activeElement",document.activeElement),editorLog("menu on",editableChildren[0]),edit_menu_for(editableChildren[0],"entering"),""}if("end"==s){editorLog("theChooseCurrent",a);p=_;editorLog("object_to_be_entered",p),p.classList.remove("may_select"),p.classList.remove("may_enter"),p.classList.remove("may_leave"),
editorLog('next_editable_of(object_to_be_entered, "children")'),editableChildren=next_editable_of(p,"children");var h=editableChildren.length;return i+=1,current_editing.level=i,current_editing.location[i]=h-1,current_editing.tree[i]=editableChildren,editorLog("current_editing",current_editing),editorLog("object_to_be_entered",p),editorLog("with some children",editableChildren),editorLog("menu place 10end"),editorLog("document.activeElement",document.activeElement),editorLog("menu on",editableChildren[h-1]),edit_menu_for(editableChildren[h-1],"entering"),""}if("beforebegin"==s||"afterend"==s||"afterbegin"==s){a.parentElement.classList.add("past"),a.removeAttribute("id"),a.classList.add("chosen");var b=document.getElementById("edit_menu_holder").parentElement.parentElement.id;return b||(editorLog(document.getElementById("edit_menu_holder").parentElement.parentElement,"has no id, so going down one level"),b=document.getElementById("edit_menu_holder").parentElement.id),editorLog("making a menu for",b),(w=document.createElement("ol")).innerHTML=menu_options_for(b,"","base"),editorLog("just inserted inner menu_options_for("+b+")",menu_options_for(b,"","base")),a.insertAdjacentElement("beforeend",w),document.getElementById("choose_current").focus(),editorLog("focus is on",$(":focus")),""}editorLog("Error: unknown dataLocation:",s)}else if(d)if("edit"==d)editorLog("going to edit",_),edit_in_place(_,"old");else if("replace"==d)editorLog("replace",_,"by id",_.id),replace_by_id(_.id,"html");else if("stop_editing"==d)editorLog("stop_editing",_,"by id",_.id),replace_by_id(_.id,"html"),eraseCookie(chosen_edit_option_key);else if("save"==d)save_source(),edit_menu_from_current_editing("entering");else if("resume"==d)editorLog("resuming previous editing session"),resume_editing();else{if("change-env-to"==d){var f=a.getAttribute("data-env");editorLog("changing environment to",f),r=document.getElementById("edit_menu_holder").parentElement.parentElement.parentElement,editorLog("to_be_edited",r);var v=r.id,L=internalSource[v];editorLog("current envoronemnt",L);var x=internalSource[v].sourcetag;internalSource[v].sourcetag=f,recent_editing_actions.push([x,f,v]),editorLog("the change was","changed "+x+" to "+f+" "+v);var y=html_from_internal_id(v);return editorLog("B: the_whole_object",y),$("#"+v).replaceWith(y[0]),editorLog("just edited",$("#"+v)),editorLog("curent_editing level",current_editing.level,"with things",current_editing.tree[current_editing.level]),current_editing.level-=1,current_editing.tree[current_editing.level]=next_editable_of(document.getElementById(v).parentElement,"children"),editorLog("now curent_editing level",current_editing.level,"with things",current_editing.tree[current_editing.level]),edit_menu_from_current_editing("entering"),""}if("change-env"==d){current_env=document.getElementById("edit_menu_holder").parentElement.parentElement.parentElement,current_env_id=current_env.id,a.parentElement.classList.add("past"),a.removeAttribute("id"),a.classList.add("chosen");var w=document.createElement("ol");editorLog("J1 lookinh for menu options for",current_env_id),w.innerHTML=menu_options_for(current_env_id,"","change"),editorLog("just inserted inner menu_options_for(parent_type)",menu_options_for(current_env_id,"","change")),a.insertAdjacentElement("beforeend",w),document.getElementById("choose_current").focus(),editorLog("focus is on",$(":focus"))}else if("modify"==d)if(current_env=document.getElementById("edit_menu_holder").parentElement,current_env_id=current_env.id,c)"done"==c?edit_menu_from_current_editing("entering"):"arrows"==c||(current_env_id||(current_env_id=current_env.getAttribute("data-parent_id"),editorLog("current_env_id from parent",current_env_id)),modify_by_id(current_env_id,c));else{a.parentElement.classList.add("past"),a.removeAttribute("id"),a.classList.add("chosen");w=document.createElement("ol");current_env_id||(w.setAttribute("id","edit_menu"),w.setAttribute("class","edit_menu"),current_env_id=current_env.getAttribute("data-parent_id"),editorLog("current_env_id",current_env_id)),editorLog("J2a looking for menu options for",current_env_id),w.innerHTML=menu_options_for(current_env_id,"","modify"),editorLog("just inserted inner menu_options_for(parent_type)",menu_options_for(current_env_id,"","modify")),"SPAN"==a.tagName?a.replaceWith(w):a.insertAdjacentElement("beforeend",w),document.getElementById("choose_current").focus(),editorLog("focus is on",$(":focus"))}else if("move-or-delete"==d){current_env=document.getElementById("edit_menu_holder").parentElement,editorLog("current_env",current_env),current_env_id=current_env.id,a.parentElement.classList.add("past"),a.removeAttribute("id"),a.classList.add("chosen");w=document.createElement("ol");editorLog("J3 looking for menu options for",current_env_id),w.innerHTML=menu_options_for(current_env_id,"","move-or-delete"),editorLog("just inserted inner menu_options_for(parent_type)",menu_options_for(current_env_id,"","move-or-delete")),a.insertAdjacentElement("beforeend",w),document.getElementById("choose_current").focus(),editorLog("focus is on",$(":focus"))}else if("delete"==d)current_env=document.getElementById("edit_menu_holder").parentElement,editorLog("current_env",current_env),current_env_id=current_env.id,delete_by_id(current_env_id,"choice");else if(["move-local","move-local-p","move-local-li"].includes(d))current_env=document.getElementById("edit_menu_holder").parentElement,current_env_id=current_env.id,handle_env_id=current_env_id,"move-local-li"==d&&(current_env.classList.remove("may_select"),current_env=current_env.parentElement,current_env.classList.add("may_select"),current_env_id=current_env.id),editorLog("current_env",current_env),move_by_id_local(current_env_id,handle_env_id);else if("change-title"==d){var j=standard_title_form(document.getElementById("edit_menu_holder").parentElement.parentElement.getAttribute("data-parent_id"));document.getElementById("edit_menu_holder").parentElement.insertAdjacentHTML("afterend",j),document.getElementById("edit_menu_holder").parentElement.remove(),editorLog("change-title in progress"),document.getElementById("actively_editing").focus()}else{if("change-caption"==d)return void alert("editing captions not implemented yet");editorLog("unknown dataAction",d),alert("I don;t know what to do llllllll dataAction "+d)}}else if(l){if(e.preventDefault(),editorLog("in dataEnv",l),editorLog("selected a menu item with no action and no location"),$("#choose_current").parent().addClass("past"),editorLog("apparently selected",a),a.removeAttribute("id"),a.setAttribute("class","chosen"),l in submenu_options)editorLog("making a menu for",l),(w=document.createElement("ol")).innerHTML=menu_options_for("",l,"inner"),a.insertAdjacentElement("beforeend",w),document.getElementById("choose_current").focus();else if(l in objectStructure||g in objectStructure){editorLog("making a new",l,"within",g);var E=$("#edit_menu_holder > #edit_menu > .chosen").attr("data-location");if("source"==l)return alert(" making source"),show_source(_,E),void edit_menu_from_current_editing("entering");editorLog("create object to edit",l,_,E);var k=create_object_to_edit(l,_,E);if(!k)return edit_menu_from_current_editing("entering"),"";editorLog("new_obj",k),edit_in_place(k,"new");var S=k.id;if(editorLog("are we editing id",S),editorLog("are we editing",k),editorLog("  JJJ  current_editing",current_editing.level,current_editing.location.length,current_editing.tree.length,current_editing.tree[current_editing.level]),editorLog("    current_editing",current_editing),_.classList.remove("may_select"),_.classList.remove("may_enter"),(tmp=document.getElementById("edit_menu_holder"))&&tmp.remove(),l.startsWith("sbs")){editorLog("added sbs, now add to it",S),editorLog("document.getElementById(new_obj_id)",document.getElementById(S));var A=document.getElementById(S).firstElementChild.firstElementChild.id;editorLog("first_panel_id",A,document.getElementById(A)),make_current_editing_tree_from_id(A),edit_menu_from_current_editing("entering")}}else editorLog("Error: unknown dataEnv",l),editorLog("Or maybe unknown dataEnvParent",g),editorLog("moving up the menu -- not"),alert("Sorry, not implemented yet!"),a.classList.remove("chosen"),a.parentElement.classList.remove("past"),a.setAttribute("id","choose_current")}}else editorLog("key that is not meaningful when navigating a menu:",e.code);else e.preventDefault(),next_menu_item=a.nextSibling,editorLog("theChooseCurrent",a,"next_menu_item",next_menu_item),next_menu_item||(next_menu_item=a.parentNode.firstChild),editorLog("theChooseCurrent",a,"next_menu_item",next_menu_item),a==next_menu_item&&(n==o.length-1?(i-=1,n=current_editing.location[i],current_editing.level=i,current_editing.location[i]=n,edit_menu_from_current_editing("leaving")):(n+=1,editorLog("single item menu, current_location now",n),current_editing.location[i]=n,edit_menu_from_current_editing("entering"))),a.removeAttribute("id"),editorLog("theChooseCurrent",a,"next_menu_item",next_menu_item),next_menu_item.setAttribute("id","choose_current"),editorLog("setting focus on",next_menu_item),next_menu_item.focus()}}function logKeyDown(e){if("ShiftLeft"!=e.code&&"ShiftRight"!=e.code&&"Shift"!=e.code){prev_prev_char=prev_char,prev_char=this_char,this_char=e,editorLog("logKey",e,"XXX",e.code),editorLog("are we editing",document.getElementById("actively_editing")),editorLog("is there already an edit menu?",document.getElementById("edit_menu_holder"));var t=document.activeElement;if(editorLog("input_region",t),document.getElementById("actively_editing")){if(editorLog("                 we are actively editing"),"Tab"==e.code&&!document.getElementById("local_menu_holder"))return e.preventDefault(),"";document.getElementById("local_menu_holder")?main_menu_navigator(e):local_editing_action(e)}else if(document.getElementById("phantomobject")){document.getElementById("phantomobject").classList.contains("move")?move_object(e):alert("do not know what to do with that")}else main_menu_navigator(e)}}function initialize_editing(e){createCookie(chosen_edit_option_key,1,.01),xmlToObject(e=(e=(e=e.replace(/<\/mrow>\s*<mrow>/g," \n\\cr\n ")).replace(/<mrow>/g," ")).replace(/<\/mrow>/g," ")),record_children(sourceobj),internalSource=re_transform_source(),current_editing={level:0,location:[0],tree:[[internalSource.root_data.id]]},e_tree=current_editing.tree,editorLog("e_tree",e_tree),e_level=current_editing.level,editorLog("e_level",e_level),e_location=current_editing.location,editorLog("e_location",e_location),replace_by_id(internalSource.root_data.id,"html"),edit_menu_for(e_tree[e_level][e_location],"entering"),document.getElementById("content").classList.add("canedit"),MathJax.typesetPromise()}function xml_id_of(e){var t="";if(e.attributes.length>0){parseLog(e.nodeName,"has attributes",e.attributes);for(var i=0;i<e.attributes.length;i++){var n=e.attributes.item(i);"permid"==n.nodeName&&(t=n.nodeValue),t||"xml:id"!=n.nodeName||(t=n.nodeValue)}}return t||(t=randomstring()),t}function xmlToObject(e){var t;"string"==typeof e?(parser=new DOMParser,t=parser.parseFromString(e,"text/xml")):t=e,parseLog("xml",t),parseLog("xml.nodeName",t.nodeName,"xml.nodeType",t.nodeType);var i="",n=t.nodeValue;if(9==t.nodeType&&(t=t.documentElement),parseLog("this_node_content",n),1==t.nodeType){i=xml_id_of(t),new_top_id||(top_level_id=new_top_id=i,sourceobj.root_data={id:new_top_id,number_base:"X.Y"}),parseLog("found this_id",i);var o={};if(o["xml:id"]=i,["ol","ul","dl"].includes(t.nodeName)?o.sourcetag="list":o.sourcetag=t.nodeName,n="",t.hasChildNodes())for(var r=0;r<t.childNodes.length;r++){var a=t.childNodes.item(r);if(8==a.nodeType);else if(3==a.nodeType)n+=a.nodeValue;else if(1==a.nodeType){var s=xmlToObject(a);contained_objects.includes(a.nodeName)?o[a.nodeName]=s:n+="<&>"+s+"<;>"}else parseLog("what to do with this node?",a)}if(n&&(o.content=n.trim()),t.attributes.length>0)for(var d=0;d<t.attributes.length;d++){var c=t.attributes.item(d);if("source"==c.nodeName)o.source=c.nodeValue;else if("ref"==c.nodeName)o.ref=c.nodeValue;else if("text"==c.nodeName)o.text=c.nodeValue;else if("width"==c.nodeName){var l=c.nodeValue;l.endsWith("%")&&(l=l.slice(0,-1)),o.width=l}else if("margins"==c.nodeName){var _=c.nodeValue.split(" ");if(1==_.length){var g=_[0];g.endsWith("%")&&(g=g.slice(0,-1)),o.marginleft=g,o.marginright=g}else if(2==_.length){var[u,m]=_;u.endsWith("%")&&(u=u.slice(0,-1)),m.endsWith("%")&&(m=m.slice(0,-1)),o.marginleft=u,o.marginright=m}}}return"image"==t.nodeName&&(t.attributes.width||(o.width=100),t.attributes.margins||(o.marginleft=0,o.marginright=0)),t.attributes&&parseLog(t,"has attributes",t.attributes),contained_objects.includes(t.nodeName)?n:(sourceobj[i]=o,i)}8==t.nodeType?n="":t.nodeType}function record_children(e){for(key in e){var t=e[key];if("content"in t){var i=t.content;parseLog("this_content",i);for(var n=i.match(/<&>.*?<;>/g)||"",o=0;o<n.length;++o){var r=n[o].slice(3,-3);parseLog("this_child",r,"has a parent",key),e[r].parent=[key,"content"]}}if("statement"in t)for(n=t.statement.match(/<&>.*?<;>/g)||"",o=0;o<n.length;++o){e[r=n[o].slice(3,-3)].parent=[key,"statement"]}if("proof"in t)for(n=t.proof.match(/<&>.*?<;>/g)||"",o=0;o<n.length;++o){e[r=n[o].slice(3,-3)].parent=[key,"proof"]}}return e}function re_transform_source(){var e=[];for(var t in sourceobj){if("list"==(w=sourceobj[t]).sourcetag){parseLog("found a list",w);var[i,n]=w.parent;if(parseLog("with parent",sourceobj[i]),"p"==sourceobj[i].sourcetag){var[o,r]=sourceobj[i].parent;parseLog("with parents parent",sourceobj[o]);var a=sourceobj[o][r].replace("<&>"+i+"<;>","<&>"+t+"<;>");sourceobj[o][r]=a,sourceobj[t].parent=[o,r],parseLog("deleting",i),e.push(i),parseLog("now sourceobj[parent_parent_id]",sourceobj[o])}}else if("image"==w.sourcetag){if("width"in w&&!("marginleft"in w)){parseLog("no width in"+w["xml:id"]);var s=.5*(100-parseInt(w.width));w.marginleft=s,w.marginright=s}}else if(["md","mdn","me","men"].includes(w.sourcetag)){parseLog("found displaymath",w),parseLog("with parent",sourceobj[w.parent[0]]);var d=w["xml:id"];"includedmath"in sourceobj[w.parent[0]]?sourceobj[w.parent[0]].includedmath.push("<&>"+d+"<;>"):sourceobj[w.parent[0]].includedmath=["<&>"+d+"<;>"]}else if(["caption"].includes(w.sourcetag)){parseLog("found a caption",w);var[i,n]=w.parent;if(parseLog("with parent",sourceobj[i]),"figure"==sourceobj[i].sourcetag){var c=sourceobj[i][n].replace("<&>"+t+"<;>","");sourceobj[i][n]=c,sourceobj[i].captiontext=sourceobj[t].content,e.push(t),parseLog("now sourceobj[parent_id]",sourceobj[i]),alert("testing")}else alert("error: caption not in figure")}}for(var t in sourceobj){if("p"==(w=sourceobj[t]).sourcetag&&"includedmath"in w){for(var l=w.parent,_=sourceobj[l[0]][l[1]],g=w.includedmath,u=w.content,m=[],p=0;p<g.length;++p){var h=g[p];m.push([u.indexOf(h),h])}m.sort(),parseLog("sorted list",m),parseLog("ocntent before splitting up",_),h=m[0][1],parseLog("this_math_tag",h);var b=h.slice(3,-3);parseLog("this_math_id",b),parseLog("with source",sourceobj[b]);var f=new RegExp("^(.*"+h+")(.)s*(.*)$","s"),v=u.replace(f,"$2");[".",",",";",":"].includes(v)&&(u=u.replace(f,"$1$3"),sourceobj[b].content+=v);var L=new RegExp("^.*"+h,"s"),x=new RegExp(h+".*$","s");sourceobj[t].content=u.replace(x,""),sourceobj[t].sourcetag="ip",u=u.replace(L,""),parseLog("updated this_content",u),sourceobj[b].parent=l,_=_.replace("<&>"+t+"<;>","<&>"+t+"<;>\n"+h),parseLog("updated context_of_outer_parent",_),sourceobj[l[0]][l[1]]=_;var y="XXXX"+randomstring();sourceobj[y]={"xml:id":y,sourcetag:"mp"},sourceobj[y].content=u,sourceobj[y].parent=l,_=_.replace(h,h+"\n<&>"+y+"<;>"),sourceobj[l[0]][l[1]]=_;for(p=1;p<m.length;++p){b=(h=m[p][1]).slice(3,-3);f=new RegExp("^(.*"+h+")(.)s*(.*)$","s"),v=u.replace(f,"$2");[".",",",";",":"].includes(v)&&(u=u.replace(f,"$1$3"),sourceobj[b].content+=v),L=new RegExp("^.*"+h,"s"),x=new RegExp(h+".*$","s"),sourceobj[y].content=u.replace(x,""),u=u.replace(L,""),sourceobj[b].parent=l,_=_.replace("<&>"+y+"<;>","<&>"+y+"<;>\n"+h),sourceobj[l[0]][l[1]]=_,y="XXXX"+randomstring(),sourceobj[y]={"xml:id":y,sourcetag:"mp"},sourceobj[y].content=u,sourceobj[y].parent=l,_=_.replace(h,h+"\n<&>"+y+"<;>"),sourceobj[l[0]][l[1]]=_}sourceobj[y].sourcetag="fp"}}for(var t in sourceobj){var w=sourceobj[t];if(["p","ip","mp","fp"].includes(w.sourcetag))u=(u=sourceobj[t].content).replace(/\n +/g,"\n"),sourceobj[t].content=u;else if(["me","men","md","mdn"].includes(w.sourcetag)){u=(u=sourceobj[t].content).replace(/\n +/g,"\n  "),sourceobj[t].content=u}if(["figure"].includes(w.sourcetag)){editorLog("adjusting a figure",w);var j=sourceobj[t].caption;j=j.replace(/\n +/g,"\n"),sourceobj[t].captiontext=j}}for(p=1;p<e.length;++p);return sourceobj}editorLog=console.log,debugLog=function(){},parseLog=console.log,errorLog=console.log,editing_mode=0,current_page=location.host+location.pathname,debugLog("current_page",current_page),chosen_edit_option_key="edit_option".concat(current_page),chosen_edit_option=readCookie(chosen_edit_option_key)||"",editing_mode=chosen_edit_option,debugLog("chosen_edit_option",chosen_edit_option,"chosen_edit_option",chosen_edit_option>0),objectStructure={type:{html:{tag:"span",attributes:['class="type"','data-parent_id="<&>xml:id<;>"','data-editable="70XX"','tabindex="-1"'],pieces:[["(capitalize,sourcetag)",""]]}},"type-child":{html:{tag:"span",attributes:['class="type"','data-editable="70YY"','tabindex="-1"'],pieces:[["(capitalize,sourcetag)",""]]}},"type-proof":{html:{tag:"span",attributes:['class="type"','data-editable="70YY"','tabindex="-1"'],pieces:[["(literal,Proof)",""]]}},sectiontype:{html:{tag:"span",attributes:['class="type"'],pieces:[["(capitalize,sourcetag)",""]]}},codenumber:{html:{tag:"span",attributes:['class="codenumber"'],pieces:[["(codenumber,)",""]]}},period:{html:{tag:"span",attributes:['class="period"'],pieces:[["(period,)",""]]}},comma:{html:{tag:"span",attributes:['class="comma"'],pieces:[["(comma,)",""]]}},titleperiod:{html:{tag:"span",attributes:['class="period"'],pieces:[["(titleperiod,)",""]]}},space:{html:{tag:"span",attributes:['class="space"'],pieces:[["(space,)",""]]}},title:{html:{tag:"span",attributes:['class="title"','data-editable="70"','tabindex="-1"'],pieces:[["title",""]]}},nbsp:{html:{tag:"",pieces:[["(literal,&nbsp;)",""]]},pretext:{tag:"nbsp",pieces:[]},source:{pieces:[]}},idx:{html:{tag:"",pieces:[]},pretext:{tag:"idx",pieces:[["content",""]]},source:{pieces:[["content",""]]}},h:{html:{tag:"",pieces:[]},pretext:{tag:"h",pieces:[["content",""]]},source:{pieces:[["content",""]]}},theorem_like_heading:{html:{tag:"h4",cssclass:"heading",attributes:['class="<&>{cssclass}<;>"','data-parent_id="<&>xml:id<;>"'],pieces:[["{type}",""],["{space}",""],["{codenumber}",""],["{period}",""],["{space}",""],["{title}",""],["{titleperiod}",""]]}},proof_like_heading:{html:{tag:"h5",cssclass:"heading",attributes:['class="<&>{cssclass}<;>"','xml:id="<&>xml:id<;>"'],pieces:[["{type-child}",""],["{period}",""]]}},proof_heading:{html:{tag:"h5",cssclass:"heading",attributes:['class="<&>{cssclass}<;>"','xml:id="<&>xml:id<;>"'],pieces:[["{type-proof}",""],["{period}",""]]}},section_like_heading:{html:{tag:"h2",cssclass:"heading hide-type",attributes:['class="<&>{cssclass}<;>"','data-parent_id="<&>xml:id<;>"'],pieces:[["{sectiontype}",""],["{codenumber}",""],["{space}",""],["{title}",""]]}},title_heading:{html:{tag:"h2",cssclass:"heading",attributes:['class="<&>{cssclass}<;>"','data-parent_id="<&>xml:id<;>"'],pieces:[["{title}",""],["{period}",""]]}},task_like_heading:{html:{tag:"h6",cssclass:"heading",attributes:['class="<&>{cssclass}<;>"','data-parent_id="<&>xml:id<;>"'],pieces:[["{codenumber}",""],["{space}",""],["{title}",""]]}},caption_like_heading:{html:{tag:"h5",cssclass:"captionheading",attributes:['class="<&>{cssclass}<;>"','data-parent_id="<&>xml:id<;>"'],pieces:[["{type}",""],["{space}",""],["{codenumber}",""],["{period}",""],["{space}",""]]}},xref:{html:{tag:"span",attributes:['class="ref tmp"','id="<&>xml:id<;>"','ref="<&>ref<;>"'],pieces:[["(literal,REFERENCE)",""]]},pretext:{tag:"xref",attributes:['ref="<&>ref<;>"','text="<&>text<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]],attributes:[["ref","*"],["text",""],["detail",""],["first",""],["last",""]]}},introduction:{html:{tag:"section",attributes:['class="introduction"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["content",""]]},pretext:{tag:"introduction",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},conclusion:{html:{tag:"section",attributes:['class="conclusion"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{proof_like_heading}",""],["content",""]]},pretext:{tag:"conclusion",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},worksheet:{html:{tag:"section",attributes:['class="worksheet"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"worksheet",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},section:{html:{tag:"section",attributes:['class="section"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"section",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},subsection:{html:{tag:"section",attributes:['class="subsection"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"subsection",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},paragraphs:{html:{tag:"section",attributes:['class="paragraphs"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{title_heading}",""],["content",""]]},pretext:{tag:"paragraphs",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},exercises:{html:{tag:"section",attributes:['class="exercises"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"exercises",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},exercisegroup:{html:{tag:"section",attributes:['class="exercisegroup"','id="<&>xml:id<;>"','data-editable="XYX"','tabindex="-1"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"exercisegroup",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["title","*"],["content","p"]]}},page:{html:{tag:"section",attributes:['class="onepage"','id="<&>xml:id<;>"','data-editable="PPP"','tabindex="-1"'],pieces:[["content",""]]},pretext:{tag:"page",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content","p"]]}},objectives:{html:{tag:"article",cssclass:"objectives",pieces:[["{proof_like_heading}",""],["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],data_editable:"160"},pretext:{tag:"objectives",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content","p"]]}},p:{html:{tag:"p",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"99"},pretext:{tag:"p",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},ip:{html:{tag:"p",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"99"},pretext:{tag_opening:"\n<p",tag_closing:"",attributes:['xml:id="<&>xml:id<;>">\n'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},mp:{html:{tag:"p",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="mp"'],data_editable:"99"},pretext:{tag_opening:"",tag_closing:"",attributes:[],pieces:[["content",""]]},source:{pieces:[["content",""]]}},fp:{html:{tag:"p",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="fp"'],data_editable:"99"},pretext:{tag_opening:"",tag_closing:"\n</p>\n",attributes:[],pieces:[["content",""]]},source:{pieces:[["content",""]]}},li:{html:{tag:"li",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"'],data_editable:"98aZ"},pretext:{tag:"li",pieces:[["title","title"],["content",""]]},source:{pieces:[["title",""],["content","p"]]}},blockquote:{html:{tag:"blockquote",pieces:[["content",""],["attribution",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],cssclass:"blockquote",data_editable:"44?"},pretext:{tag:"blockquote",pieces:[["content",""],["attribution","attribution"]]},source:{pieces:[["content","p"],["attribution",""]]}},list:{html:{tag:"ol",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','list-style-type="a"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"AAA"},pretext:{tag:"ol",pieces:[["content",""]],attributes:['label="A"']},source:{pieces:[["title",""],["content","li"]],attributes:[["label","A"]]}},figure:{html:{tag:"figure",pieces:[["content",""],["{caption}",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],data_editable:"32",cssclass:"figure figure-like"},pretext:{tag:"figure",pieces:[["content"],["{caption}"]],attributes:['xml:id="<&>xml:id<;>"']},source:{pieces:[["content",""],["captiontext",""]],attributes:[]}},image:{html:{tag:"div",pieces:[["{bareimage}",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"','style="width: <&>width<;>%; margin-right: <&>marginright<;>%; margin-left: <&>marginleft<;>%"'],data_editable:"31",cssclass:"image-box"},pretext:{tag:"image",pieces:[],attributes:['xml:id="<&>xml:id<;>"','source="<&>source<;>"','alt="<&>alt<;>"','width="<&>width<;>%"','margins="<&>marginleft<;>% <&>marginright<;>%"']},source:{pieces:[["",""]],attributes:[["source",""],["width","40"],["marginleft","20"],["marginright","40"],["alt",""]]}},bareimage:{html:{tag:"img",pieces:[],attributes:['src="<&>source<;>"','alt="<&>alt<;>"','class="contained"']}},sidebyside:{html:{tag:"div",pieces:[["{sbsrow}",""]],attributes:['id="<&>xml:id<;>"','class="<&>{cssclass}<;>"'],cssclass:"sidebyside"},pretext:{tag:"sidebyside",pieces:[["content",""]],attributes:['xml:id="<&>xml:id<;>"','margins="<&>marginleft<;>% <&>marginright<;>%"','width="<&>(percentlist,widths)<;>"']},source:{pieces:[["content",""]],attributes:[["marginleft",""],["marginright",""],["widths",""]]}},sbsrow:{html:{tag:"div",pieces:[["content",""]],attributes:['class="<&>{cssclass}<;>"','style="margin-right: <&>marginright<;>%; margin-left: <&>marginleft<;>%"'],data_editable:"89",cssclass:"sbsrow"},pretext:{tag:"",pieces:[["content",""]],attributes:[]},source:{pieces:[["content",""]],attributes:[["marginleft","20"],["marginright","40"]]}},sbspanel:{html:{tag:"div",pieces:[["content",""]],attributes:['id="<&>xml:id<;>"','class="<&>{cssclass}<;>"','style="width:<&>(nthitem,widths)<;>%"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"90",cssclass:"sbspanel"},pretext:{tag:"stack",pieces:[["content",""]],attributes:['xml:id="<&>xml:id<;>"']},source:{pieces:[["content",""]]}},proof:{html:{tag:"article",cssclass:"proof",pieces:[["{proof_heading}",""],["proof",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],data_editable:"60"},pretext:{tag:"proof",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["proof",""]]},source:{pieces:[["content","p"]]}},"proof-standalone":{html:{tag:"article",cssclass:"proof",pieces:[["{XXXXXnorbeingusedXXXXXXX_proof_heading}",""],["content",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],data_editable:"60"},pretext:{tag:"proof",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content","p"]]}},caption:{html:{tag:"figcaption",data_editable:"321",attributes:['id="<&>xml:id<;>"'],pieces:[["{caption_like_heading}",""],["{captiontext}",""]]},pretext:{tag:"caption",attributes:[],pieces:[["captiontext",""]]},source:{pieces:[["content",""]]}},captiontext:{html:{tag:"p",data_editable:"321",attributes:['data-source_id="<&>xml:id<;>"','data-component="caption"','class="caption"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],pieces:[["captiontext",""]]},pretext:{tag:"",attributes:[],pieces:[["captiontext",""]]},source:{pieces:[["captiontext",""]]}},references:{html:{tag:"article",cssclass:"bib",data_editable:"33",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{section_like_heading}",""],["content",""]]},pretext:{tag:"references",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title",""],["content",""]]},source:{pieces:[["title",""],["content",""]]}},biblio:{html:{tag:"div",cssclass:"bibentry",data_editable:"333",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{bib-title}",""],["{journal}",""],["{volume}",""],["{number}",""],["{author}",""],["{pages}",""]]},pretext:{tag:"biblio",attributes:['xml:id="<&>xml:id<;>"','type="raw"'],pieces:[["title",""],["journal",""],["volume",""],["number",""],["author",""],["pages",""]]},source:{pieces:[["title",""],["journal",""],["volume",""],["number",""],["author",""],["pages",""]]}},"bib-title":{html:{tag:"i",pieces:[["title","zz"]]}},author:{html:{tag:"",pieces:[["author",""],["{comma}",""]]}},journal:{html:{tag:"",pieces:[["journal",""]]}},volume:{html:{tag:"b",pieces:[["volume",""]]}},pages:{html:{tag:"jjj",pieces:[["pages",""]]}},number:{html:{tag_opening:"no. ",tag_closing:" ",pieces:[["number",""]]}},"remark-like":{html:{tag:"article",cssclass:"remark-like",data_editable:"92",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{theorem_like_heading}",""],["statement",""]]},pretext:{attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["statement","statement"]]},source:{pieces:[["title",""],["statement","p"]]}},"project-like-tasks":{html:{tag:"article",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],cssclass:"project-like",data_editable:"194",pieces:[["{theorem_like_heading}",""],["content",""],["tasks",""]]},pretext:{tag:"sourcetag",pieces:[["title","title"],["content",""],["tasks",""]],attributes:['xml:id="<&>xml:id<;>"']},source:{pieces:[["title",""],["content","p"],["tasks",""]]}},"project-like":{html:{tag:"article",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],cssclass:"project-like",data_editable:"94",pieces:[["{theorem_like_heading}",""],["statement",""],["%hint%","hint"],["%answer%","answer"],["%solution%","solution"],["{workspace}",""]]},pretext:{tag:"sourcetag",pieces:[["title","title"],["statement","statement"],["hint","hint"],["answer","answer"],["solution","solution"]],attributes:['xml:id="<&>xml:id<;>"','workspace="<&>workspace<;>"']},source:{pieces:[["title",""],["statement","p"],["hint",""],["answer",""],["solution",""]],attributes:[["workspace","0"]]}},"definition-like":{html:{tag:"article",cssclass:"definition-like",data_editable:"95a",pieces:[["{theorem_like_heading}",""],["statement",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"']},pretext:{attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["statement","statement"]]},source:{pieces:[["title",""],["statement","p"]]}},"theorem-like":{html:{tag:"article",cssclass:"theorem-like",data_editable:"93",pieces:[["{theorem_like_heading}",""],["statement",""],["{proof}",""]],attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"']},pretext:{attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["statement","statement"],["{proof}",""]]},source:{pieces:[["title",""],["statement","p"],["proof",""]]}},task:{html:{tag:"article",
cssclass:"exercise-like task",data_editable:"94ZZZA",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{task_like_heading}",""],["statement",""],["%hint%","hint"],["%answer%","answer"],["%solution%","solution"],["{workspace}",""]]},pretext:{tag:"task",pieces:[["title","title"],["statement","statement"],["hint",""],["answer",""],["solution",""]],attributes:['workspace="<&>workspace<;>"']},source:{pieces:[["title",""],["statement","p"],["hint",""],["answer",""],["solution",""]],attributes:[["workspace","0"]]}},hint:{html:{tag:"article",cssclass:"solution-like hint",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{proof_like_heading}",""],["content",""]],data_editable:"hhhh"},pretext:{tag:"hint",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["content","p"]]}},answer:{html:{tag:"article",cssclass:"solution-like answer",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{proof_like_heading}",""],["content",""]],data_editable:"hhhh"},pretext:{tag:"answer",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["content","p"]]}},solution:{html:{tag:"article",cssclass:"solution-like solution",attributes:['id="<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[["{proof_like_heading}",""],["content",""]],data_editable:"hhhh"},pretext:{tag:"solution",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["title","title"],["content",""]]},source:{pieces:[["content","p"]]}},workspace:{html:{tag:"div",cssclass:"workspace",data_editable:"WwW",attributes:['data-parent_id="<&>xml:id<;>"','data-space="<&>workspace<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"','class="<&>{cssclass}<;>"'],pieces:[]}},term:{html:{tag:"dfn",attributes:['id="<&>xml:id<;>"','class="terminology"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"ttt",pieces:[["content",""]]},pretext:{tag:"term",pieces:[["content",""]]},source:{pieces:[["content",""]]}},em:{html:{tag:"em",attributes:['id="<&>xml:id<;>"','class="emphasis"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"eemm",pieces:[["content",""]]},pretext:{tag:"em",pieces:[["content",""]]},source:{pieces:[["content",""]]}},fn:{html:{tag:"a",attributes:['id="<&>xml:id<;>"','class="id-ref fn-knowl original"','data-knowl=" "','href=" "','data-refid="hk-<&>xml:id<;>"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"fnfnfn",pieces:[["(literal,footnote)","sup"]]},pretext:{tag:"fn",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},alert:{html:{tag:"em",attributes:['id="<&>xml:id<;>"','class="alert"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"aall",pieces:[["content",""]]},pretext:{tag:"alert",pieces:[["content",""]]},source:{pieces:[["content",""]]}},init:{html:{tag:"abbr",attributes:['id="<&>xml:id<;>"','class="initialism"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"iinniitt",pieces:[["content",""]]},pretext:{tag:"init",pieces:[["content",""]]},source:{pieces:[["content",""]]}},c:{html:{tag:"code",attributes:['id="<&>xml:id<;>"','class="code-inline tex2jax_ignore"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"ccoo",pieces:[["content",""]]},pretext:{tag:"c",pieces:[["content",""]]},source:{pieces:[["content",""]]}},ellipsis:{html:{tag:"span",attributes:['id="<&>xml:id<;>"','class="abbrev"','contenteditable="false"'],data_editable:"abbr",pieces:[["(literal,&hellip;)",""]]},pretext:{tag:"ellipsis",pieces:[]},source:{}},etc:{html:{tag:"span",attributes:['id="<&>xml:id<;>"','class="abbrev"','contenteditable="false"'],pieces:[["(literal,etc)",""]]},pretext:{tag:"etc",pieces:[]},source:{}},q:{html:{tag:"q",attributes:['id="<&>xml:id<;>"','class="quote"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"qqq",pieces:[["content",""]]},pretext:{tag:"q",pieces:[["content",""]]},source:{pieces:[["content",""]]}},m:{html:{tag_opening:"<span class='process-math'>\\(",tag_closing:"\\)</span>",pieces:[["content",""]]},pretext:{tag:"m",pieces:[["content",""]]},source:{pieces:[["content",""]]}},me:{html:{tag:"div",attributes:['id="<&>xml:id<;>"','class="displaymath process-math"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"42",pieces:[["{me_raw}",""]]},pretext:{tag:"me",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},men:{html:{tag:"div",attributes:['id="<&>xml:id<;>"','class="displaymath process-math"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"42",pieces:[["{me_raw}",""]]},pretext:{tag:"men",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},md:{html:{tag:"div",attributes:['id="<&>xml:id<;>"','class="displaymath process-math"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"42",pieces:[["{md_raw}",""]]},pretext:{tag:"md",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},mdn:{html:{tag:"div",attributes:['id="<&>xml:id<;>"','class="displaymath process-math"','data-editable="<&>{data_editable}<;>"','tabindex="-1"'],data_editable:"42",pieces:[["{me_raw}",""]]},pretext:{tag:"mdn",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}},me_raw:{html:{tag_opening:"\\begin{equation*}",tag_closing:"\\end{equation*}",pieces:[["content",""]]}},md_raw:{html:{tag_opening:"\\begin{align*}",tag_closing:"\\end{align*}",pieces:[["content",""]]}},mrow:{html:{tag_opening:"",tag_closing:"\\cr",data_editable:"422",pieces:[["content",""]]},pretext:{tag:"mrow",attributes:['xml:id="<&>xml:id<;>"'],pieces:[["content",""]]},source:{pieces:[["content",""]]}}};var environment_instances={"definition-like":["definition","conjecture","axiom","principle","heuristic","hypothesis","assumption"],"theorem-like":["lemma","proposition","theorem","corollary","claim","fact","identity","algorithm"],"remark-like":["remark","warning","note","observation","convention","insight"],"project-like-tasks":["investigation","exploration","project"],"project-like":["exercise","activity"]};for(const[e,t]of Object.entries(environment_instances))for(var data_editable_base=objectStructure[e].html.data_editable,cssclass_base=objectStructure[e].html.cssclass,source_pieces=objectStructure[e].source.pieces,pretext_pieces=objectStructure[e].pretext.pieces,pretext_attributes=objectStructure[e].pretext.attributes||[],source_attributes=objectStructure[e].source.attributes||[],j=0;j<t.length;++j){var this_tag=t[j];objectStructure[this_tag]={owner:e,html:{tag:objectStructure[e].html.tag,pieces:objectStructure[e].html.pieces,attributes:objectStructure[e].html.attributes,cssclass:cssclass_base+" "+this_tag,data_editable:data_editable_base+j.toString(),heading:objectStructure[e].html.heading},pretext:{tag:this_tag,pieces:pretext_pieces,attributes:pretext_attributes},source:{tag:this_tag,pieces:source_pieces,attributes:source_attributes}}}editorLog('objectStructure["exercise"]',objectStructure.exercise);var sidebyside_instances={sbs:[["2 panels","sbs2"],["3 panels","sbs3"],["4 panels","sbs4"]],sbs2:[["full across","sbs_0_50_50_0"],["gap but no margin","sbs_0_45_45_0"],["spaced equally","sbs_5_40_40_5"]],sbs3:[["full across","sbs_0_34_32_34_0"],["gap but no margin","sbs_0_28_28_38_0"],["spaced equally","sbs_5_25_26_25_5"]],sbs4:[["full across","sbs_0_25_25_25_25_0"],["gap but no margin","sbs_0_20_20_20_20_0"],["spaced equally","sbs_3_18_18_18_18_3"]]};Object.assign(objectStructure,sidebyside_instances);var always_empty_tags=["img","image","xref"],allowed_empty_tags=["div","span","p","stack"],tag_display={inline:["m","em","ellipsis","span","term","dfn","q","c","code","alert","nbsp","xref","idx","h","init"],title:["title","idx","h1","h2","h3","h4","h5","h6","div","usage","image"],"block-tight":[]};inline_tags=tag_display.inline,inline_math=["m"],inline_abbrev=["ellipsis","ie","eg","etc"];var contained_objects=["title","statement","caption","captiontext","proof","author","journal","volume","number","pages"];$(".autopermalink > a").attr("tabindex",-1);var editable_objects=[["p",99],["ol",97],["ul",96],["article",95],["blockquote",80],["section",66],["title",20],["caption",890]];for(j=0;j<editable_objects.length;++j)$(editable_objects[j][0]).attr("data-editable",editable_objects[j][1]),$(editable_objects[j][0]).attr("tabindex",-1);editorLog(" enabling edit"),user_level="novice",this_char="",prev_char="",prev_prev_char="",move_scale=1,magnify_scale=1,final_added_object="",previous_added_object="",this_focused_element="",prev_focused_element="",prev_prev_focused_element="";var menu_neutral_background="#ddb",menu_active_background="#fdd",recent_editing_actions=[],ongoing_editing_actions=[],old_content={},keyletters=["KeyA","KeyB","KeyC","KeyD","KeyE","KeyF","KeyG","KeyH","KeyI","KeyJ","KeyK","KeyL","KeyM","KeyN","KeyO","KeyP","KeyQ","KeyR","KeyS","KeyT","KeyU","KeyV","KeyW","KeyX","KeyY","KeyZ"],movement_location_options=[],movement_location=0,first_move=!0;Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t,function(e,t){return t.toFixed?Number(t.toFixed(3)):t}))},Storage.prototype.getObject=function(e){var t=this.getItem(e);return t&&JSON.parse(t)};var submenu_options={"math-like":[["me"],["chem"],["code"]],"image-like":[["image"],["video"],["audio"]],"aside-like":[["aside"],["historical"],["biographical"]],"list-like":[["itemized list","list"],["dictionary list","dl"],["table"]],"layout-like":[["side-by-side panels","sbs"],["assemblage"],["biographical aside"],["titled paragraph","paragraphs"]],"section-like":["section","subsection","paragraphs","rq","exercises"],sbs:[["2 panels","sbs2"],["3 panels","sbs3"],["4 panels","sbs4"]],"list-like":[["itemized list","list"],["dictionary list","dl"],["table"]],"example-like":["example","question","problem"]};Object.assign(submenu_options,sidebyside_instances),Object.assign(submenu_options,environment_instances),base_menu_for={section:[["paragraph","p"],["display math/chemistry/code","math-like","c"],["list or table","list-like"],["example-like","example-like"],["definition-like","definition-like"],["theorem-like","theorem-like"],["remark-like"],["project/exercise-like","project-like","j"],["image/video/sound","image-like","v"],["blockquote/poem/music/etc","quoted"],["aside-like","aside-like","d"],["interactives"],["proof","proof-standalone","o"],["layout-like"],["section-like"],["PreTeXt source","source"]],paragraphs:[["paragraph","p"],["display math/chemistry/code","math-like","c"],["list or table","list-like"],["example-like","example-like"],["definition-like","definition-like"],["theorem-like","theorem-like"],["remark-like"],["project/exercise-like","project-like","j"],["image/video/sound","image-like","v"],["blockquote/poem/music/etc","quoted"],["aside-like","aside-like","d"],["interactives"],["proof","proof-standalone","o"],["layout-like"],["PreTeXt source","source"]],blockquote:[["paragraph","p"]],article:[["paragraph","p"],["math/chemistry/code","math-like","c"],["list or table","list-like"],["image/video/sound","image-like","v"]],li:[["new list item","li","i"],["paragraph","p"],["list or table","list-like"],["math/chemistry/code","math-like","c"],["image/video/sound","image-like","v"]],p:[["emphasis-like"],["formula"],["abbreviation"],["symbol"],["ref or link","ref"]]},base_menu_for.proof=base_menu_for.article,base_menu_for.page=base_menu_for.section,editing_container_for={p:1,ip:1,mp:1,fp:1,"theorem-like":["theorem","proposition","lemma","corollary","claim","fact","identity","algorithm"],"definition-like":["definition","conjecture","axiom","hypothesis","principle","heuristic","assumption"],"remark-like":["remark","warning","note","observation","convention","insight"],"example-like":["example","question","problem"],"exercise-like":["exercise"],ol:["item"],li:[""],list:[""],image:[""],sbs2:[""],sbs3:[""],sbs4:[""],source:1,"proof-standalone":[""],proof:[""]};var this_source_txt,internalSource={root_data:{id:"page-1",number_base:"0.1"}},top_level_id=internalSource.root_data.id,current_editing={level:0,location:[0],tree:[[document.getElementById(top_level_id)]]};editorLog("adding tab listener"),document.addEventListener("keydown",logKeyDown),document.addEventListener("focus",function(){prev_prev_focused_element=prev_focused_element,prev_focused_element=this_focused_element,this_focused_element=document.activeElement,$(".in_edit_tree").removeClass("in_edit_tree"),$("#edit_menu_holder:first-child").parent().addClass("in_edit_tree"),$("#edit_menu_holder").prev().addClass("in_edit_tree")},!0);var source_url=window.location.href;source_url=(source_url=source_url.replace(/(#|\?).*/,"")).replace(/html$/,"ptx"),fetch(source_url).then(function(e){return e.text()}).then(function(e){(this_source_txt=e).includes("404 Not")||this_source_txt.includes("<biblio ")||(edit_choice=document.createElement("span"),edit_choice.setAttribute("class","login-link"),editing_mode?(initialize_editing(this_source_txt),edit_choice.innerHTML=""):edit_choice.innerHTML="<span id='edit_choice'>Edit this page</span>",document.getElementById("ptx-content").insertAdjacentElement("beforeend",edit_choice),$("#edit_choice").on("click",function(){initialize_editing(this_source_txt),document.getElementById("edit_choice").remove()}))});var sourceobj={},new_top_id="";