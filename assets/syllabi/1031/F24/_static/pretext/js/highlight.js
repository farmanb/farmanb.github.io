function index_of_child(t){for(var e=0;null!=(t=t.previousSibling);)e++;return e}function increment_id(t){if(0==t.length)return 0;id_start=t[0].id.replace(/^(.*?)[0-9]+$/,"$1"),current_endings=[];for(var e=0;e<t.length;++e)current_endings.push(t[e].id.replace(/^.*?([0-9]+)$/,"$1"));return current_max=Math.max(...current_endings),id_start+(parseInt(current_max)+1)}function enclosing_p_or_li(t){return t?"P"==t.tagName||"LI"==t.tagName?t:enclosing_p_or_li(t.parentNode):null}async function display_one_highlight(t,e){var n=document.getElementById(t);if(!n)return;var i=e.start_nn,l=e.start_offset,h=e.end_nn,d=e.end_offset;if(l<0||i>n.childNodes.length||h>n.childNodes.length||l>n.childNodes[i].textContent.length||d<0||d>n.childNodes[h].textContent.length)return;let s=document.createRange();s.setStart(n.childNodes[i],l),s.setEnd(n.childNodes[h],d);var a=document.createElement("span");a.classList.add("hl"),a.id=e.id,s.surroundContents(a)}async function display_highlights_on(t,e,n){n<e.length&&(await display_one_highlight(t,e[n]),++n,await display_highlights_on(t,e,n))}async function display_all_highlights(t,e,n){n<e.length&&(await display_highlights_on(e[n],t[e[n]],0),++n,await display_all_highlights(t,e,n))}function save_highlights(){hl_data={action:"save",user:uname,pw:emanu,bookID:bodyID,type:"highlights",hl:JSON.stringify(all_highlights)},$.ajax({url:"https://aimath.org/cgi-bin/u/highlights.py",type:"post",data:JSON.stringify(hl_data),dataType:"json",success:function(){},error:function(){}})}function newhighlight(){var t=window.getSelection();if(t.toString().length>=3)return num_selected_ranges=t.rangeCount,starting_parent=enclosing_p_or_li(t.getRangeAt(0).startContainer),starting_parent_id=starting_parent.id,ending_parent_id=enclosing_p_or_li(t.getRangeAt(num_selected_ranges-1).endContainer).id,starting_node=t.getRangeAt(0),starting_node_container=starting_node.startContainer,starting_node_number=index_of_child(starting_node_container),starting_node_offset=starting_node.startOffset,ending_node=t.getRangeAt(num_selected_ranges-1),ending_node_container=ending_node.endContainer,ending_node_number=index_of_child(ending_node_container),ending_node_offset=ending_node.endOffset,t.empty(),starting_parent_id!=ending_parent_id?(alert("Highlights must be within\none paragraph or list item."),""):(starting_parent!=starting_node_container.parentNode&&(starting_node_number=index_of_child(starting_node_container.parentNode)-1,starting_node_offset=starting_parent.childNodes[starting_node_number].length),starting_parent!=ending_node_container.parentNode&&(ending_node_number=index_of_child(ending_node_container.parentNode)+1,ending_node_offset=0),this_highlight={start_nn:starting_node_number,start_offset:starting_node_offset,end_nn:ending_node_number,end_offset:ending_node_offset},starting_parent_id in all_highlights?(new_id=increment_id(all_highlights[starting_parent_id]),this_highlight.id=new_id,all_highlights[starting_parent_id].push(this_highlight)):(this_highlight.id=starting_parent_id+"-hl1",all_highlights[starting_parent_id]=[this_highlight]),display_one_highlight(starting_parent_id,this_highlight),localStorage.setObject("all_highlights",all_highlights),"guest"!=uname&&"student"==role&&save_highlights(),"")}function modifyhighlight(t){this_hl=t.target;var e=t.clientX,n=t.clientY;document.getElementById("hlmenu").style.top=n-10+$(window).scrollTop()+"px",document.getElementById("hlmenu").style.left=e+20+"px",document.getElementById("hlmenu").style.display="block",document.getElementsByClassName("hlcopy")[0].setAttribute("data-hlid",this_hl.id),document.getElementsByClassName("hldelete")[0].setAttribute("data-hlid",this_hl.id);for(var i=this_hl.id.replace(/^(.*)-[^\-]*$/,"$1"),l=this_hl.id.slice(-1),h=all_highlights[i],d=(h[l-1],this_hl.childNodes.length),s=0;s<d;++s);for(s=0;s<h.length;++s);1==this_hl.childNodes.length&&3==this_hl.previousSibling.nodeType&&this_hl.nextSibling.nodeType}function copyStringToClipboard(t){var e=document.createElement("textarea");e.value=t,e.setAttribute("readonly",""),e.style={position:"absolute",left:"-9999px"},document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}hlmenu=document.createElement("div"),hlmenu.id="hlmenu",hlmenu.style.display="none",hlmenu_contents='<div class="hlcopy" data-hlid="">copy to clipboard</div>\n',hlmenu_contents+='<div class="hldelete" data-hlid="">delete highlight</div>\n',hlmenu_contents+='<div class="dismiss">dismiss menu</div>',hlmenu.innerHTML=hlmenu_contents,document.body.appendChild(hlmenu);var all_highlights=localStorage.getObject("all_highlights");all_highlights||(all_highlights={}),MathJax.Hub.Register.StartupHook("End",function(){display_all_highlights(all_highlights,Object.keys(all_highlights),0)});var DELAY=500,clicks=0,timer=null;$("p[id], li[id]").on("click",function(t){1===++clicks?t.target.classList.contains("hl")?(modifyhighlight(t),clicks=0):timer=setTimeout(function(){newhighlight(),clicks=0},DELAY):2===clicks?timer2=setTimeout(function(){clearTimeout(timer),clicks=0},DELAY/2):(clearTimeout(timer),clearTimeout(timer2),clicks=0)}),$("body").on("click",".hlcopy",function(){var t=this.getAttribute("data-hlid");hl_to_copy=document.getElementById(t),the_highlight=hl_to_copy.innerHTML,copyStringToClipboard(the_highlight),document.getElementById("hlmenu").style.display="none"}),$("body").on("click",".hldelete",function(){var t=this.getAttribute("data-hlid");hl_to_delete=document.getElementById(t);for(var e,n,i=t.replace(/^(.*)-[^\-]*$/,"$1"),l=document.getElementById(i).childNodes,h={},d=0,s=0;s<l.length;++s)l[s].id&&(h[l[s].id]=d,d+=1),l[s].id==t&&(n=l[s].childNodes.length-1);for(s=0;s<all_highlights[i].length;++s){h[(_=all_highlights[i][s]).id]==h[t]&&(e=_.end_offset,the_hl_to_delete=all_highlights[i][s])}var a,o=[],g=!1;for(s=0;s<all_highlights[i].length;++s){var _=all_highlights[i][s];if(g)if(h[_.id]<h[t])o.push(_);else{if(h[_.id]==h[t])continue;_.start_nn==the_hl_to_delete.start_nn+2?((a=_).start_nn+=-2+n,a.end_nn+=-2+n,a.start_offset+=e,a.end_offset+=e,o.push(a)):((a=_).start_nn+=-2+n,a.end_nn+=-2+n,o.push(a))}else _.id==t?g=!0:o.push(_)}o.length>0?all_highlights[i]=o:delete all_highlights[i],localStorage.setObject("all_highlights",all_highlights),$(hl_to_delete).replaceWith(hl_to_delete.innerHTML),document.getElementById(i).normalize(),document.getElementById("hlmenu").style.display="none"}),$("body").on("click",".dismiss",function(){the_parent=this.closest("[id]"),the_parent.style.display="none"});