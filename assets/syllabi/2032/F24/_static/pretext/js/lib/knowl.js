function addKnowls(t){const e=t.querySelectorAll("[data-knowl]");for(const t of e)LinkKnowl.initializeXrefKnowl(t);const n=t.querySelectorAll(".born-hidden-knowl");for(const t of n){const e=t.querySelector(":scope > summary"),n=t.querySelector(":scope > summary + *");new SlideRevealer(e,n,t)}}window.addEventListener("load",()=>{addKnowls(document)});class SlideRevealer{static STATE=Object.freeze({INACTIVE:0,CLOSING:1,EXPANDING:2});constructor(t,e,n){this.triggerElement=t,this.contentElement=e,this.animatedElement=n,this.animation=null,this.animationState=SlideRevealer.STATE.INACTIVE,this.triggerElement.addEventListener("click",t=>this.onClick(t))}onClick(t){t&&t.preventDefault(),this.animatedElement.style.overflow="hidden",this.animationState!==SlideRevealer.STATE.CLOSING&&this.animatedElement.hasAttribute("open")?(this.animationState===SlideRevealer.STATE.EXPANDING||this.animatedElement.hasAttribute("open"))&&this.toggle(!1):(this.animatedElement.setAttribute("open",""),this.triggerElement.setAttribute("open",""),this.contentElement.style.display="",window.requestAnimationFrame(()=>this.toggle(!0)))}toggle(t){let e=0;this.animatedElement.contains(this.triggerElement)&&(e=this.triggerElement.offsetHeight);const n=e+this.contentElement.offsetHeight,i=`${t?e:n}px`,l=`${t?n:e}px`,o=this.animatedElement.offsetHeight-this.animatedElement.clientHeight,a=`${t?0:o}px`,s=`${t?o:0}px`;this.animation&&this.animation.cancel();const r=Math.max(Math.min(Math.abs(e-n)/400*1e3,750),250);this.animationState=t?SlideRevealer.STATE.EXPANDING:SlideRevealer.STATE.CLOSING,this.animation=this.animatedElement.animate({height:[i,l],paddingTop:[a,s],paddingBottom:[a,s]},{duration:r,easing:"ease"}),this.animation.onfinish=()=>{this.onAnimationFinish(t)},this.animation.oncancel=()=>{this.animationState=SlideRevealer.STATE.INACTIVE}}onAnimationFinish(t){this.animation=null,this.animationState=SlideRevealer.STATE.INACTIVE,t||(this.animatedElement.removeAttribute("open"),this.triggerElement.removeAttribute("open")),this.animatedElement.style.overflow="",t||(this.contentElement.style.display="none")}}class LinkKnowl{static xrefCount=0;static initializeXrefKnowl(t){if(null===t.getAttribute("data-knowl-uid"))return new LinkKnowl(t)}constructor(t){this.linkElement=t,this.outputElement=null,this.uid=LinkKnowl.xrefCount++,t.setAttribute("data-knowl-uid",this.uid),t.setAttribute("role","button"),t.setAttribute("data-base-title",t.getAttribute("title")||this.linkElement.textContent),t.classList.add("knowl__link"),this.updateLabels(!1),t.addEventListener("click",this.handleLinkClick.bind(this))}updateLabels(t){const e=(t?this.linkElement.getAttribute("data-close-label")||"Close":this.linkElement.getAttribute("data-reveal-label")||"Reveal")+" "+this.linkElement.getAttribute("data-base-title");this.linkElement.setAttribute("aria-label",e),this.linkElement.setAttribute("title",e)}toggle(){this.linkElement.classList.toggle("active");const t=this.linkElement.classList.contains("active");if(this.updateLabels(t),t){this.outputElement.getBoundingClientRect().height>window.innerHeight?this.outputElement.scrollIntoView(!0):this.outputElement.getBoundingClientRect().bottom>window.innerHeight&&this.outputElement.scrollIntoView(!1)}}findOutputLocation(){const t="table, mjx-container, div.tabular-box, .runestone > .parsons";let e=this.linkElement.parentElement,n=e.closest(t);for(;n&&n!==e;)e=n,n=e.closest(t);return e}createOutputElement(){const t=`<div class='knowl__content' style='display:none;' id='${"knowl-uid-"+this.uid}' aria-live='polite' id='${"knowl-output-"+this.uid}'>Loading '${this.linkElement.getAttribute("data-knowl")}'</div>`,e=document.createElement("template");e.innerHTML=t,this.outputElement=e.content.children[0];this.findOutputLocation(this.linkElement).after(this.outputElement)}async getContent(){const t=this.linkElement.getAttribute("data-knowl");return await fetch(t).then(t=>t.text()).then(t=>{let e=(new DOMParser).parseFromString(t,"text/html"),n=e.body,i=e.querySelectorAll("head script");return n.append(...i),n}).catch(t=>`<div class='knowl-output__error'><div class='para'>Error fetching content. (<em>${t}</em>)</div><div class='para'><a href='${this.linkElement.getAttribute("href")}'>Navigate to ${this.linkElement.textContent}</a> instead.</div><div class='para'>If you are viewing this book from your local filesystem, this is expected behavior. To view the book with all features, you must serve the book from a web server. See the <a href="https://pretextbook.org/doc/guide/html/author-faq.html#how-do-i-view-my-book-locally">PreTeXt FAQ</a> for more information.</div></div>`)}handleLinkClick(event){if(event.preventDefault(),null!==this.outputElement)this.toggle();else{this.createOutputElement();const slideHandler=new SlideRevealer(this.linkElement,this.outputElement,this.outputElement);this.linkElement.addEventListener("click",slideHandler);let loadingTimeout=setTimeout(()=>{loadingTimeout=null,slideHandler.onClick(),this.toggle()},500);const content=this.getContent();content.then(tempContainer=>{null!==loadingTimeout&&clearTimeout(loadingTimeout),setTimeout(()=>{slideHandler.onClick(),this.toggle()},100);const runestoneElements=tempContainer.querySelectorAll(".ptx-runestone-container");[...runestoneElements].forEach(t=>{const e=t.querySelector("[data-component]")?.id;document.getElementById(e)?t.innerHTML=`<div class="para">The interactive that belongs here is already on the page and cannot appear multiple times. <a href="#${e}">Scroll to interactive.</a>`:window.runestoneComponents.renderOneComponent(t)});const children=[...tempContainer.children];this.outputElement.innerHTML="",this.outputElement.append(...children),MathJax.typesetPromise([this.outputElement]),addKnowls(this.outputElement),[...this.outputElement.getElementsByTagName("script")].forEach(s=>{null!==s.getAttribute("type")&&"text/javascript"!==s.getAttribute("type")||eval(s.innerHTML)})}).catch(()=>{})}}}